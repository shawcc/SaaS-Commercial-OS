<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Commercial OS V15 - The Complete Edition</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-sidebar: #0f172a;
            --bg-app: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --sidebar-w: 260px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #cbd5e1; height: 100vh; display: flex; justify-content: center; align-items: center;
            color: var(--text-main);
        }

        .app-window {
            width: 1600px; height: 950px; background: var(--bg-app); border-radius: 12px;
            display: flex; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        /* --- Sidebar --- */
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); color: #cbd5e1; display: flex; flex-direction: column; flex-shrink: 0;}
        .logo-box { height: 64px; border-bottom: 1px solid #1e293b; display: flex; align-items: center; padding: 0 24px; font-weight: 700; font-size: 16px; color: white; gap: 10px;}
        
        .nav-group { padding: 24px 16px 0; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 8px; padding-left: 12px; }
        .nav-item {
            padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; transition: 0.2s;
        }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-icon { margin-right: 10px; width: 20px; text-align: center; }

        /* --- Main Content --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 64px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; flex-shrink: 0;}
        .page-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .content { flex: 1; overflow-y: auto; padding: 32px; }

        /* --- UI Components --- */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-weight: 600; font-size: 15px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f1f5f9; }
        .btn-icon { padding: 4px 8px; background: transparent; color: var(--text-sub); font-size: 14px; border:none; cursor: pointer;}
        .btn-icon:hover { color: var(--text-main); background: #f1f5f9; border-radius: 4px; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 24px; font-size: 12px; color: var(--text-sub); border-bottom: 1px solid var(--border); background: #f8fafc; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        td { padding: 14px 24px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        
        .code-pill { font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: #475569; border: 1px solid #e2e8f0; font-size: 12px;}

        .tag { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-block; }
        .tag-blue { background: #eff6ff; color: #1d4ed8; }
        .tag-orange { background: #fff7ed; color: #c2410c; }
        .tag-purple { background: #faf5ff; color: #7e22ce; }
        .tag-green { background: #dcfce7; color: #166534; }
        .tag-red { background: #fef2f2; color: #991b1b; }

        /* --- Packaging Views --- */
        .prod-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .prod-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; position: relative; }
        .prod-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: var(--primary); }
        .prod-icon { width: 48px; height: 48px; background: #eff6ff; color: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px; font-weight: bold;}

        /* Matrix */
        .matrix-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: white; margin-bottom: 30px;}
        .matrix-cell { text-align: center; cursor: pointer; transition: 0.2s; }
        .matrix-cell:hover { background: #f8fafc; }
        .check-box { width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 4px; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
        .check-box.checked { background: var(--primary); border-color: var(--primary); color: white; }
        .check-box.checked::after { content: 'âœ“'; font-size: 12px; font-weight: bold; }

        /* Add-ons */
        .addon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .addon-card { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; height: 140px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer;}
        .addon-card:hover { border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* --- Tenant Card --- */
        .tenant-card { background: white; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.2s; }
        .tenant-card:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .tenant-header { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .tenant-body { padding: 20px 24px; background: #f8fafc; }
        
        .sub-group { margin-bottom: 20px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; overflow: hidden; }
        .sub-group:last-child { margin-bottom: 0; }
        .sub-group-header { padding: 10px 16px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        
        .sub-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; }
        .sub-row:last-child { border-bottom: none; }
        .sub-name { font-weight: 500; font-size: 14px; color: var(--text-main); }
        .sub-meta { font-size: 12px; color: #94a3b8; display: flex; gap: 15px; align-items: center; }

        /* --- Modals & Drawers --- */
        .mask { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 500px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; }
        .modal-head { padding: 16px 24px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; }
        .modal-body { padding: 24px; }
        .modal-foot { padding: 16px 24px; border-top: 1px solid var(--border); text-align: right; background: #f8fafc; }
        
        .drawer { position: absolute; top:0; right:0; bottom:0; width: 500px; background: white; z-index: 200; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; box-shadow: -10px 0 25px rgba(0,0,0,0.1); }
        .drawer.open { transform: translateX(0); }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-sub); }
        .form-input, .form-select { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }

    </style>
</head>
<body>

<div class="app-window">
    
    <div class="sidebar">
        <div class="logo-box">ğŸ’  SaaS OS V15</div>

        <div class="nav-group">
            <div class="nav-label">Layer 1 & 2: èµ„äº§å®šä¹‰</div>
            <div class="nav-item active" id="nav-features" onclick="route('features')">
                <span class="nav-icon">ğŸ”§</span> æŠ€æœ¯ç‰¹æ€§ (Features)
            </div>
            <div class="nav-item" id="nav-caps" onclick="route('caps')">
                <span class="nav-icon">ğŸ“¦</span> å•†ä¸šèƒ½åŠ› (Capabilities)
            </div>
            <div class="nav-item" id="nav-rules" onclick="route('rules')">
                <span class="nav-icon">ğŸ›¡ï¸</span> è§„åˆ™å¼•æ“ (Rules)
            </div>
        </div>

        <div class="nav-group">
            <div class="nav-label">Layer 3: å•†å“åŒ…è£…</div>
            <div class="nav-item" id="nav-products" onclick="route('products')">
                <span class="nav-icon">ğŸ·ï¸</span> äº§å“çº¿ç®¡ç†
            </div>
        </div>
        
        <div class="nav-group">
            <div class="nav-label">Layer 4: å±¥çº¦è¿è¥</div>
            <div class="nav-item" id="nav-ents" onclick="route('ents')">
                <span class="nav-icon">ğŸ‘¥</span> å®¢æˆ·æƒç›Šç®¡ç†
            </div>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <div class="page-title" id="page-title">äº§å“çº¿ç®¡ç†</div>
            <div id="page-actions"></div>
        </div>
        <div class="content" id="main-content">
            </div>
    </div>
</div>

<div class="mask" id="modal-feature">
    <div class="modal">
        <div class="modal-head"><span>æ³¨å†Œ Feature</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">æŠ€æœ¯ ID</label><input class="form-input" id="feat-id" placeholder="feat_key"></div>
            <div class="form-group"><label class="form-label">åç§°</label><input class="form-input" id="feat-name"></div>
            <div class="form-group"><label class="form-label">æŠ€æœ¯è´Ÿè´£äºº</label><input class="form-input" id="feat-owner"></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveFeature()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-cap">
    <div class="modal">
        <div class="modal-head"><span>å®šä¹‰ Capability</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">èƒ½åŠ›åç§°</label><input class="form-input" id="cap-name"></div>
            <div class="form-group"><label class="form-label">ä½œç”¨åŸŸ</label>
                <select class="form-select" id="cap-scope">
                    <option value="WORKSPACE">å·¥ä½œåŒºçº§ (Workspace)</option>
                    <option value="TENANT">ç§Ÿæˆ·çº§ (Tenant)</option>
                    <option value="GLOBAL">å…¨åŸŸçº§ (Global)</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">ç»‘å®šåº•å±‚ Feature</label><select class="form-select" id="cap-feat"></select></div>
            <div class="form-group"><label class="form-label">å½’å±äº§å“çº¿</label><select class="form-select" id="cap-prod"></select></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveCap()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-rule">
    <div class="modal">
        <div class="modal-head"><span>æ–°å»ºè§„åˆ™</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">ç±»å‹</label>
                <select class="form-select" id="rule-type">
                    <option value="MUTEX">æŠ€æœ¯äº’æ–¥ (Mutex)</option>
                    <option value="DEPEND">ä¾èµ–å…³ç³» (Dependency)</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">æè¿°</label><input class="form-input" id="rule-desc"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label class="form-label">æº</label><select class="form-select" id="rule-src"></select></div>
                <div class="form-group" style="flex:1"><label class="form-label">ç›®æ ‡</label><select class="form-select" id="rule-tgt"></select></div>
            </div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveRule()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-sku">
    <div class="modal">
        <div class="modal-head"><span>æ–°å»º SKU</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">SKU åç§°</label><input class="form-input" id="sku-name"></div>
            <div class="form-group"><label class="form-label">ç±»å‹</label>
                <select class="form-select" id="sku-type"><option value="PLAN">ç‰ˆæœ¬ (Plan)</option><option value="ADDON">å¢å€¼åŒ… (Add-on)</option></select>
            </div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveSku()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-new-t">
    <div class="modal">
        <div class="modal-head"><span>ç­¾çº¦æ–°å®¢æˆ·</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">ä¼ä¸šåç§°</label><input class="form-input" id="new-t-name"></div>
            <div class="form-group"><label class="form-label">é¦–è´­äº§å“</label><select class="form-select" id="new-t-prod" onchange="updateSkuOptions()"></select></div>
            <div class="form-group"><label class="form-label">é€‰æ‹© SKU</label><select class="form-select" id="new-t-sku"></select></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveNewTenant()">ç­¾çº¦</button></div>
    </div>
</div>

<div class="mask" id="modal-sub">
    <div class="modal">
        <div class="modal-head"><span>æƒç›Šå˜æ›´</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">å¸­ä½</label><input type="number" class="form-input" id="sub-seats"></div>
            <div class="form-group"><label class="form-label">çŠ¶æ€</label><select class="form-select" id="sub-status"><option value="Active">Active</option><option value="Suspended">Suspended</option></select></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveSub()">ä¿å­˜</button></div>
    </div>
</div>

<div class="drawer" id="drawer">
    <div style="padding:20px; border-bottom:1px solid #e2e8f0; font-weight:600; display:flex; justify-content:space-between;">
        <span id="drawer-title">é…ç½® Add-on</span><span style="cursor:pointer" onclick="closeDrawer()">âœ•</span>
    </div>
    <div style="flex:1; overflow-y:auto; padding:0;" id="drawer-list"></div>
    <div style="padding:20px; border-top:1px solid #e2e8f0; text-align:right;">
        <button class="btn btn-primary" onclick="closeDrawer()">å®Œæˆé…ç½®</button>
    </div>
</div>
<div class="mask" id="drawer-overlay" onclick="closeDrawer()" style="z-index:150;"></div>

<script>
    // ================== DATA INITIALIZATION ==================
    
    // 1. Products
    let products = [
        { id: 'p_basic', name: 'Basic', code: 'BSC', icon: 'B' },
        { id: 'p_proj', name: 'Project', code: 'PRJ', icon: 'P' },
        { id: 'p_ipd', name: 'IPD', code: 'IPD', icon: 'I' },
        { id: 'p_ltc', name: 'LTC', code: 'LTC', icon: 'L' }
    ];

    // 2. Features (Restored for completeness)
    let features = [
        { id: 'f_auth', name: 'Auth Core', owner: 'Platform Team' },
        { id: 'f_gantt', name: 'Gantt Engine', owner: 'Proj Team' },
        { id: 'f_code', name: 'Git Integration', owner: 'IPD Team' },
        { id: 'f_pay', name: 'Payment Gateway', owner: 'LTC Team' }
    ];

    // 3. Capabilities (Mapped to Products & Features)
    let capabilities = [
        { id: 'c1', name: 'SSO ç™»å½•', scope: 'TENANT', prod: 'p_basic', fid: 'f_auth' },
        { id: 'c2', name: 'ç»„ç»‡æ¶æ„', scope: 'TENANT', prod: 'p_basic', fid: null },
        { id: 'c3', name: 'ç”˜ç‰¹å›¾', scope: 'WORKSPACE', prod: 'p_proj', fid: 'f_gantt' },
        { id: 'c4', name: 'èµ„æºè§†å›¾', scope: 'WORKSPACE', prod: 'p_proj', fid: null },
        { id: 'c5', name: 'éœ€æ±‚ç®¡ç†', scope: 'WORKSPACE', prod: 'p_ipd', fid: null },
        { id: 'c6', name: 'ä»£ç å…³è”', scope: 'WORKSPACE', prod: 'p_ipd', fid: 'f_code' },
        { id: 'c7', name: 'åˆåŒç®¡ç†', scope: 'WORKSPACE', prod: 'p_ltc', fid: null },
        { id: 'c8', name: 'å›æ¬¾è®¡åˆ’', scope: 'WORKSPACE', prod: 'p_ltc', fid: 'f_pay' }
    ];

    // 4. Rules
    let rules = [
        { id: 'r1', type: 'DEPEND', desc: 'èµ„æºè§†å›¾ä¾èµ–ç”˜ç‰¹å›¾', src: 'c4', tgt: 'c3' }
    ];

    // 5. SKUs (Auto-generated)
    let skus = [];
    products.forEach(p => {
        skus.push({ id: `sku_${p.code}_std`, pid: p.id, type: 'PLAN', name: 'Standard', ents: [] });
        skus.push({ id: `sku_${p.code}_prm`, pid: p.id, type: 'PLAN', name: 'Premium', ents: [] });
        skus.push({ id: `sku_${p.code}_ent`, pid: p.id, type: 'PLAN', name: 'Enterprise', ents: [] });
        skus.push({ id: `sku_${p.code}_add`, pid: p.id, type: 'ADDON', name: `${p.code} å¢å¼ºåŒ…`, ents: [] });
    });

    // 6. Tenants
    let tenants = [
        { 
            id: 't1', name: 'Acme Corp (Global)', 
            subs: [
                { skuId: 'sku_BSC_ent', seats: 2000, status: 'Active', end: '2026-01-01' },
                { skuId: 'sku_PRJ_prm', seats: 500, status: 'Active', end: '2025-06-30' },
                { skuId: 'sku_IPD_std', seats: 100, status: 'Active', end: '2025-06-30' },
                { skuId: 'sku_LTC_add', seats: 50, status: 'Active', end: '2025-06-30' }
            ]
        },
        {
            id: 't2', name: 'TechStart Inc',
            subs: [
                { skuId: 'sku_BSC_std', seats: 50, status: 'Active', end: '2024-12-31' }
            ]
        }
    ];

    // ================== STATE & ROUTING ==================
    let currView = 'features';
    let activeProdId = null;
    let editSubRef = null;
    let drawerAddonId = null;

    function route(view) {
        currView = view;
        activeProdId = null;
        updateNav();
        render();
    }
    
    function enterProduct(pid) {
        currView = 'sku_studio';
        activeProdId = pid;
        updateNav();
        render();
    }

    function updateNav() {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (currView === 'products' || currView === 'sku_studio') document.getElementById('nav-products').classList.add('active');
        else document.getElementById('nav-'+currView).classList.add('active');
    }

    function render() {
        const c = document.getElementById('main-content');
        const h = document.getElementById('page-title');
        const ha = document.getElementById('page-actions');
        c.innerHTML = ''; ha.innerHTML = '';

        if(currView === 'features') renderFeatures(c, h, ha);
        if(currView === 'caps') renderCaps(c, h, ha);
        if(currView === 'rules') renderRules(c, h, ha);
        if(currView === 'products') renderProducts(c, h, ha);
        if(currView === 'sku_studio') renderSkuStudio(c, h, ha);
        if(currView === 'ents') renderEnts(c, h, ha);
    }

    // ================== VIEWS (FULL RESTORATION) ==================

    // 1. Features
    function renderFeatures(c, h, ha) {
        h.innerText = 'Feature Registry (æŠ€æœ¯èµ„äº§)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('feature')">+ æ³¨å†Œ Feature</button>`;
        c.innerHTML = `
        <div class="card">
            <table>
                <thead><tr><th>ID</th><th>åç§°</th><th>Owner</th><th>æ“ä½œ</th></tr></thead>
                <tbody>${features.map(f => `
                    <tr>
                        <td><code class="code-pill">${f.id}</code></td>
                        <td style="font-weight:500">${f.name}</td>
                        <td>${f.owner}</td>
                        <td><button class="btn btn-icon" onclick="deleteItem('feature','${f.id}')">ğŸ—‘ï¸</button></td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>`;
    }

    // 2. Capabilities
    function renderCaps(c, h, ha) {
        h.innerText = 'Capability Library (å•†ä¸šèƒ½åŠ›)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('cap')">+ å®šä¹‰ Capability</button>`;
        c.innerHTML = `
        <div class="card">
            <table>
                <thead><tr><th>åç§°</th><th>ä½œç”¨åŸŸ</th><th>ç»‘å®š Feature</th><th>å½’å±äº§å“</th><th>æ“ä½œ</th></tr></thead>
                <tbody>${capabilities.map(cap => {
                    const f = features.find(x => x.id === cap.fid);
                    const p = products.find(x => x.id === cap.prod);
                    const tag = cap.scope==='TENANT'?'tag-blue':(cap.scope==='GLOBAL'?'tag-purple':'tag-orange');
                    return `
                    <tr>
                        <td style="font-weight:600">${cap.name}</td>
                        <td><span class="tag ${tag}">${cap.scope}</span></td>
                        <td>${f ? f.name : '<span style="color:#ccc">-</span>'}</td>
                        <td>${p ? p.code : '-'}</td>
                        <td><button class="btn btn-icon" onclick="deleteItem('cap','${cap.id}')">ğŸ—‘ï¸</button></td>
                    </tr>`;
                }).join('')}
                </tbody>
            </table>
        </div>`;
    }

    // 3. Rules
    function renderRules(c, h, ha) {
        h.innerText = 'Rule Engine (è§„åˆ™å¼•æ“)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('rule')">+ æ–°å»ºè§„åˆ™</button>`;
        c.innerHTML = `<div class="card" style="padding:24px;">${rules.map(r => {
            const s = capabilities.find(x=>x.id===r.src)?.name || r.src;
            const t = capabilities.find(x=>x.id===r.tgt)?.name || r.tgt;
            return `
            <div style="border:1px solid #e2e8f0; padding:16px; border-radius:8px; margin-bottom:12px; display:flex; align-items:center;">
                <span class="tag ${r.type==='MUTEX'?'tag-red':'tag-blue'}" style="width:60px; text-align:center; margin-right:16px;">${r.type}</span>
                <div style="flex:1;">
                    <div style="font-weight:600;">${r.desc}</div>
                    <div style="font-size:12px; color:#64748b;">${s} -> ${t}</div>
                </div>
                <button class="btn btn-icon" onclick="deleteItem('rule','${r.id}')">ğŸ—‘ï¸</button>
            </div>`;
        }).join('')}</div>`;
    }

    // 4. Products (Hierarchy)
    function renderProducts(c, h, ha) {
        h.innerText = 'äº§å“çº¿ç®¡ç† (Product Lines)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="alert('æ–°å»ºäº§å“çº¿')">+ æ–°å»ºäº§å“çº¿</button>`;
        
        c.innerHTML = `<div class="prod-grid">${products.map(p => `
            <div class="prod-card" onclick="enterProduct('${p.id}')">
                <div class="prod-icon">${p.icon}</div>
                <div style="font-weight:600; font-size:16px;">${p.name}</div>
                <div style="font-size:12px; color:#64748b; margin-top:4px;">Code: ${p.code}</div>
                <div style="margin-top:16px; font-size:13px; color:#64748b; border-top:1px solid #f1f5f9; padding-top:12px;">
                    ${skus.filter(s=>s.pid===p.id && s.type==='PLAN').length} Versions, 
                    ${skus.filter(s=>s.pid===p.id && s.type==='ADDON').length} Add-ons
                </div>
            </div>
        `).join('')}</div>`;
    }

    // 5. SKU Studio (Matrix)
    function renderSkuStudio(c, h, ha) {
        const prod = products.find(p => p.id === activeProdId);
        h.innerHTML = `<span style="color:#64748b; cursor:pointer" onclick="route('products')">äº§å“çº¿</span> <span style="margin:0 8px; color:#cbd5e1">/</span> ${prod.name}`;
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('sku')">+ æ–°å»º SKU</button>`;

        const plans = skus.filter(s => s.pid === activeProdId && s.type === 'PLAN');
        const addons = skus.filter(s => s.pid === activeProdId && s.type === 'ADDON');
        let prodCaps = capabilities.filter(c => c.prod === activeProdId);
        if(prodCaps.length === 0) prodCaps = [{id:'temp', name:'(è¯·å…ˆå®šä¹‰èƒ½åŠ›)', scope:'-'}]

        c.innerHTML = `
        <h3 style="font-size:15px; margin-bottom:12px;">Plan Matrix</h3>
        <div class="matrix-container">
            <table>
                <thead>
                    <tr>
                        <th style="background:white; min-width:200px;">èƒ½åŠ›åŸå­</th>
                        ${plans.map(p => `<th>${p.name}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${prodCaps.map(cap => `
                        <tr>
                            <td><div style="font-weight:500">${cap.name}</div><div style="font-size:11px; color:#999">${cap.scope}</div></td>
                            ${plans.map(p => {
                                const checked = p.ents.includes(cap.id);
                                return `<td class="matrix-cell" onclick="toggleEnt('${p.id}','${cap.id}')"><div class="check-box ${checked?'checked':''}"></div></td>`
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>

        <h3 style="font-size:15px; margin:24px 0 12px;">Add-ons</h3>
        <div class="addon-grid">${addons.map(a => `
            <div class="addon-card">
                <div style="font-weight:600;">${a.name}</div>
                <div style="font-size:13px; color:#64748b; margin-top:8px;">åŒ…å« ${a.ents.length} é¡¹èƒ½åŠ›</div>
                <div style="margin-top:auto; padding-top:12px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between;">
                    <button class="btn btn-icon" onclick="openDrawer('${a.id}')">âš™ï¸ é…ç½®</button>
                    <span class="tag tag-green">ADDON</span>
                </div>
            </div>`).join('')}
        </div>`;
    }

    // 6. Entitlements (360 View)
    function renderEnts(c, h, ha) {
        h.innerText = 'å®¢æˆ·æƒç›Šç®¡ç† (Tenant 360Â°)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openNewTenantModal()">+ ç­¾çº¦æ–°å®¢æˆ·</button>`;

        let html = `<div style="display:flex; flex-direction:column; gap:20px;">`;
        
        tenants.forEach(t => {
            const groupedSubs = {};
            t.subs.forEach(sub => {
                const sku = skus.find(s => s.id === sub.skuId);
                const pid = sku ? sku.pid : 'unknown';
                if(!groupedSubs[pid]) groupedSubs[pid] = [];
                groupedSubs[pid].push({ ...sub, skuName: sku ? sku.name : sub.skuId, skuType: sku ? sku.type : 'PLAN' });
            });

            html += `
            <div class="tenant-card">
                <div class="tenant-header">
                    <div>
                        <div style="font-weight:600; font-size:16px;">${t.name}</div>
                        <div style="font-size:12px; color:#64748b;">ID: ${t.id}</div>
                    </div>
                    <div class="tag tag-blue">${t.subs.length} Active Subscriptions</div>
                </div>
                <div class="tenant-body">
                    ${Object.keys(groupedSubs).map(pid => {
                        const prod = products.find(p => p.id === pid);
                        return `
                        <div class="sub-group">
                            <div class="sub-group-header">
                                <span style="background:#eff6ff; color:#2563eb; width:20px; height:20px; display:flex; align-items:center; justify-content:center; border-radius:4px;">${prod ? prod.icon : '?'}</span>
                                ${prod ? prod.name : 'Unknown Product'}
                            </div>
                            ${groupedSubs[pid].map(sub => `
                                <div class="sub-row">
                                    <div>
                                        <div class="sub-name">${sub.skuName}</div>
                                        <div class="sub-meta">
                                            <span class="tag ${sub.skuType==='PLAN'?'tag-blue':'tag-green'}">${sub.skuType}</span>
                                            <span>Until: ${sub.end}</span>
                                        </div>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:24px;">
                                        <div style="text-align:right;">
                                            <div style="font-weight:600; font-size:14px;">${sub.seats} Seats</div>
                                            <div class="tag ${sub.status==='Active'?'tag-green':'tag-red'}">${sub.status}</div>
                                        </div>
                                        <button class="btn btn-icon" onclick="openSubModal('${t.id}', '${sub.skuId}')">âœï¸</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        });
        
        html += `</div>`;
        c.innerHTML = html;
    }

    // ================== LOGIC ==================

    function openModal(id) {
        document.querySelectorAll('.mask').forEach(e=>e.style.display='none');
        document.getElementById('modal-'+id).style.display='flex';
        
        // Populate specific dropdowns
        if(id === 'cap') {
            document.getElementById('cap-feat').innerHTML = features.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
            document.getElementById('cap-prod').innerHTML = products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        }
        if(id === 'rule') {
            const opts = capabilities.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('rule-src').innerHTML = opts; document.getElementById('rule-tgt').innerHTML = opts;
        }
        if(id === 'new-t') {
            document.getElementById('new-t-prod').innerHTML = products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
            updateSkuOptions();
        }
    }
    
    function closeModals() { document.querySelectorAll('.mask').forEach(e=>e.style.display='none'); }

    // CRUD Ops
    function saveFeature() {
        const id = document.getElementById('feat-id').value;
        const name = document.getElementById('feat-name').value;
        const owner = document.getElementById('feat-owner').value;
        if(id && name) { features.push({id,name,owner}); closeModals(); render(); }
    }
    function saveCap() {
        const name = document.getElementById('cap-name').value;
        const scope = document.getElementById('cap-scope').value;
        const fid = document.getElementById('cap-feat').value;
        const prod = document.getElementById('cap-prod').value;
        if(name) { capabilities.push({id:'c'+Date.now(),name,scope,fid,prod}); closeModals(); render(); }
    }
    function saveRule() {
        const type = document.getElementById('rule-type').value;
        const desc = document.getElementById('rule-desc').value;
        const src = document.getElementById('rule-src').value;
        const tgt = document.getElementById('rule-tgt').value;
        rules.push({id:'r'+Date.now(),type,desc,src,tgt}); closeModals(); render();
    }
    function deleteItem(type, id) {
        if(!confirm('ç¡®å®šåˆ é™¤?')) return;
        if(type==='feature') features=features.filter(x=>x.id!==id);
        if(type==='cap') capabilities=capabilities.filter(x=>x.id!==id);
        if(type==='rule') rules=rules.filter(x=>x.id!==id);
        render();
    }

    function saveSku() {
        const name = document.getElementById('sku-name').value;
        const type = document.getElementById('sku-type').value;
        if(name) {
            skus.push({id:'s'+Date.now(), pid:activeProdId, type, name, ents:[]});
            closeModals(); render();
        }
    }
    function toggleEnt(sid, cid) {
        const s = skus.find(x=>x.id===sid);
        if(s.ents.includes(cid)) s.ents = s.ents.filter(x=>x!==cid);
        else s.ents.push(cid);
        render();
    }

    function updateSkuOptions() {
        const pid = document.getElementById('new-t-prod').value;
        const sSel = document.getElementById('new-t-sku');
        const availSkus = skus.filter(s => s.pid === pid && s.type === 'PLAN');
        sSel.innerHTML = availSkus.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    }
    function saveNewTenant() {
        const name = document.getElementById('new-t-name').value;
        const skuId = document.getElementById('new-t-sku').value;
        if(name && skuId) {
            tenants.push({id:'t'+Date.now(), name, subs:[{skuId, seats:100, status:'Active', end:'2025-12-31'}]});
            closeModals(); render();
        }
    }
    function openSubModal(tid, skuId) {
        const t = tenants.find(x=>x.id===tid);
        const sub = t.subs.find(x=>x.skuId===skuId);
        editSubRef = { t, sub };
        document.getElementById('sub-seats').value = sub.seats;
        document.getElementById('sub-status').value = sub.status;
        openModal('sub');
    }
    function saveSub() {
        if(editSubRef) {
            editSubRef.sub.seats = document.getElementById('sub-seats').value;
            editSubRef.sub.status = document.getElementById('sub-status').value;
            closeModals(); render();
        }
    }
    
    // Addon Drawer
    function openDrawer(sid) {
        drawerAddonId = sid;
        const addon = skus.find(s=>s.id===sid);
        const prod = products.find(p=>p.id===addon.pid);
        const prodCaps = capabilities.filter(c=>c.prod===prod.id);
        const list = document.getElementById('drawer-list');
        document.getElementById('drawer-title').innerText = `é…ç½® ${addon.name}`;
        
        list.innerHTML = prodCaps.map(c => {
            const has = addon.ents.includes(c.id);
            return `<div style="padding:12px 20px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                <div><div style="font-weight:500">${c.name}</div><div style="font-size:11px; color:#999">${c.scope}</div></div>
                <div onclick="toggleAddonEnt('${c.id}')" style="cursor:pointer"><div class="check-box ${has?'checked':''}"></div></div>
            </div>`
        }).join('');
        
        document.getElementById('drawer-overlay').style.display='block';
        document.getElementById('drawer').classList.add('open');
    }
    function closeDrawer() {
        document.getElementById('drawer').classList.remove('open');
        setTimeout(()=>document.getElementById('drawer-overlay').style.display='none',300);
        render();
    }
    function toggleAddonEnt(cid) {
        const s = skus.find(x=>x.id===drawerAddonId);
        if(s.ents.includes(cid)) s.ents = s.ents.filter(x=>x!==cid);
        else s.ents.push(cid);
        openDrawer(drawerAddonId);
    }

    // Init
    route('features');
</script>
</body>
</html>