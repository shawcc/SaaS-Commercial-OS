<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Commercial OS V43 - Bundle Integrated</title>
    <style>
        /* ================= æ ·å¼ä¿æŒ V37/38 ================= */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-sidebar: #0f172a;
            --bg-app: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --sidebar-w: 260px;
            --ai-color: #8b5cf6;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #cbd5e1; height: 100vh; display: flex; justify-content: center; align-items: center;
            color: var(--text-main);
        }

        .app-window {
            width: 100%; height: 100%; background: var(--bg-app); 
            display: flex; overflow: hidden; 
        }
        
        @media (min-width: 1200px) {
            .app-window {
                width: 1600px; height: 950px; border-radius: 12px;
                box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            }
        }

        /* --- Sidebar --- */
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); color: #cbd5e1; display: flex; flex-direction: column; flex-shrink: 0;}
        .logo-box { height: 64px; border-bottom: 1px solid #1e293b; display: flex; align-items: center; padding: 0 24px; font-weight: 700; font-size: 16px; color: white; gap: 10px;}
        
        .nav-group { padding: 24px 16px 0; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 8px; padding-left: 12px; }
        .nav-item {
            padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; transition: 0.2s;
        }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-icon { margin-right: 10px; width: 20px; text-align: center; }

        .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid #1e293b; display: flex; flex-direction: column; gap: 8px; }
        .sidebar-btn { padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; text-align: center; transition: 0.2s; border: 1px solid; display: flex; align-items: center; justify-content: center; gap: 6px;}
        
        .btn-export { background: #1e293b; color: #bae6fd; border-color: #38bdf8; }
        .btn-export:hover { background: #0c4a6e; }
        
        .btn-import { background: #1e293b; color: #bbf7d0; border-color: #4ade80; }
        .btn-import:hover { background: #064e3b; }

        .btn-reset { background: #1e293b; color: #fca5a5; border-color: #f87171; }
        .btn-reset:hover { background: #450a0a; }
        
        .btn-settings { background: #1e293b; color: #ddd6fe; border-color: #8b5cf6; }
        .btn-settings:hover { background: #4c1d95; }

        /* --- Main Content --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 64px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; flex-shrink: 0;}
        .page-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .content { flex: 1; overflow-y: auto; padding: 32px; }

        /* --- UI Kit --- */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-weight: 600; font-size: 15px; }
        .card-body { padding: 24px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f1f5f9; }
        .btn-icon { padding: 4px 8px; background: transparent; color: var(--text-sub); font-size: 14px; border:none; cursor: pointer; border-radius: 4px; }
        .btn-icon:hover { color: var(--text-main); background: #e2e8f0; }
        .btn-icon.danger:hover { color: #dc2626; background: #fee2e2; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        
        /* AI Button */
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; }
        .btn-ai:hover { opacity: 0.9; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .btn-ai:disabled { opacity: 0.6; cursor: wait; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 24px; font-size: 12px; color: var(--text-sub); border-bottom: 1px solid var(--border); background: #f8fafc; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        td { padding: 14px 24px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        
        .code-pill { font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: #475569; border: 1px solid #e2e8f0; font-size: 12px;}
        .tag { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-block; margin-right: 4px; }
        .tag-blue { background: #eff6ff; color: #1d4ed8; }
        .tag-orange { background: #fff7ed; color: #c2410c; }
        .tag-purple { background: #faf5ff; color: #7e22ce; }
        .tag-green { background: #dcfce7; color: #166534; }
        .tag-red { background: #fef2f2; color: #991b1b; }
        .tag-yellow { background: #fef3c7; color: #b45309; }
        .tag-gray { background: #f3f4f6; color: #4b5563; }

        /* --- Guide Styles --- */
        .guide-section { margin-bottom: 40px; }
        .guide-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .guide-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; position: relative; }
        .guide-text { font-size: 14px; line-height: 1.6; color: #475569; margin-bottom: 12px; }
        .guide-diagram { display: flex; gap: 16px; margin: 24px 0; overflow-x: auto; padding: 8px 0; align-items: stretch; }
        .diagram-node { background: white; border: 1px solid #cbd5e1; border-radius: 8px; padding: 16px; min-width: 180px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .diagram-node strong { display: block; color: var(--primary); margin-bottom: 4px; font-size: 15px; }
        .diagram-arrow { display: flex; align-items: center; color: #94a3b8; font-size: 24px; font-weight: bold; }

        /* --- Packaging Views --- */
        .prod-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .prod-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; position: relative; }
        .prod-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: var(--primary); }
        .prod-icon { width: 48px; height: 48px; background: #eff6ff; color: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px; font-weight: bold;}
        .prod-actions { position: absolute; top: 16px; right: 16px; opacity: 0; transition: 0.2s; display: flex; gap: 4px; }
        .prod-card:hover .prod-actions { opacity: 1; }
        
        .rel-badge { margin-top: 12px; font-size: 11px; padding: 6px 10px; border-radius: 6px; display: flex; align-items: center; gap: 6px; width: fit-content; }
        .rel-badge.depend { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .rel-badge.required { background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; margin-top: 4px; }

        /* Matrix */
        .matrix-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: white; margin-bottom: 30px;}
        .matrix-cell { text-align: center; cursor: pointer; transition: 0.2s; position: relative; }
        .matrix-cell:hover { background: #f8fafc; }
        .check-box { width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 4px; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
        .check-box.checked { background: var(--primary); border-color: var(--primary); color: white; }
        .check-box.checked::after { content: 'âœ“'; font-size: 12px; font-weight: bold; }
        .qty-badge { font-size: 13px; font-weight: 600; color: #2563eb; background: #eff6ff; padding: 4px 8px; border-radius: 6px; border: 1px solid #bfdbfe; display: inline-block; min-width: 40px; }
        .qty-badge.empty { color: #9ca3af; background: transparent; border: 1px dashed #e5e7eb; font-weight: 400; }

        .sku-header-content { display: flex; flex-direction: column; gap: 4px; padding: 8px 0; }
        .sku-header-row { display: flex; justify-content: space-between; align-items: center; }
        .sku-actions { visibility: hidden; display: flex; gap: 2px; }
        th:hover .sku-actions { visibility: visible; }
        .sku-price-tag { font-size: 12px; color: #059669; background: #ecfdf5; padding: 2px 6px; border-radius: 4px; width: fit-content; font-weight: 500; border: 1px solid #d1fae5; white-space: nowrap; }
        .matrix-cat-row { background: #f1f5f9; font-weight: 600; color: #475569; font-size: 12px; padding: 8px 24px; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Add-ons & Bundles */
        .addon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .addon-card { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; height: auto; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; position: relative;}
        .addon-card:hover { border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .addon-card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 2px; opacity: 0; transition: 0.2s; }
        .addon-card:hover .addon-card-actions { opacity: 1; }
        .addon-price { font-size: 13px; font-weight: 600; color: #059669; margin-top: 4px; }
        .tag-bundle { background: #312e81; color: #e0e7ff; border: 1px solid #4338ca; }
        /* Bundle Item Style */
        .bundle-item { background: #e0e7ff; padding: 6px 10px; border-radius: 6px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #3730a3; }
        .bundle-item button { margin-left: 8px; }

        /* Tenant Card */
        .tenant-card { background: white; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.2s; }
        .tenant-header { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .tenant-body { padding: 20px 24px; background: #f8fafc; }
        .sub-group { margin-bottom: 20px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; overflow: hidden; }
        .sub-group-header { padding: 10px 16px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .sub-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; }
        
        /* Rule Tabs */
        .rule-tabs { display: flex; gap: 20px; padding: 0 24px; border-bottom: 1px solid var(--border); background: white; margin-bottom: 20px; }
        .rule-tab { padding: 16px 0; font-size: 14px; font-weight: 500; color: var(--text-sub); cursor: pointer; border-bottom: 2px solid transparent; }
        .rule-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Modals & Drawers */
        .mask { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 550px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; }
        .modal-head { padding: 16px 24px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; }
        .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        .modal-foot { padding: 16px 24px; border-top: 1px solid var(--border); text-align: right; background: #f8fafc; }
        
        .drawer { position: absolute; top:0; right:0; bottom:0; width: 500px; background: white; z-index: 200; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; box-shadow: -10px 0 25px rgba(0,0,0,0.1); }
        .drawer.open { transform: translateX(0); }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-sub); }
        .form-input, .form-select { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }
        .form-input:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }

        /* Multi-select check list */
        .multi-check-container { max-height: 180px; overflow-y: auto; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; }
        .multi-check-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
        .multi-check-item:last-child { border-bottom: none; }
        
        /* Pricing Row */
        .pricing-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }

    </style>
</head>
<body>

<div class="app-window">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-box">ğŸ’  Meego Commercial</div>
        <div class="nav-group">
            <div class="nav-label">æŒ‡å— Guide</div>
            <div class="nav-item active" id="nav-guide" onclick="route('guide')"><span class="nav-icon">ğŸ“–</span> æ¨¡å‹è®¾è®¡æŒ‡å—</div>
        </div>
        <div class="nav-group">
            <div class="nav-label">æ ¸å¿ƒèµ„äº§</div>
            <div class="nav-item" id="nav-features" onclick="route('features')"><span class="nav-icon">ğŸ”§</span> äº§å“åŠŸèƒ½ (Features)</div>
            <div class="nav-item" id="nav-caps" onclick="route('caps')"><span class="nav-icon">ğŸ“¦</span> å•†ä¸šèƒ½åŠ› (Capabilities)</div>
        </div>
        <div class="nav-group">
            <div class="nav-label">å•†ä¸šé…ç½®</div>
            <div class="nav-item" id="nav-products" onclick="route('products')"><span class="nav-icon">ğŸ·ï¸</span> äº§å“ç®¡ç† (Products)</div>
            <div class="nav-item" id="nav-rules" onclick="route('rules')"><span class="nav-icon">ğŸ›¡ï¸</span> è§„åˆ™å¼•æ“ (Rules)</div>
        </div>
        <div class="nav-group">
            <div class="nav-label">è¿è¥å±¥çº¦</div>
            <div class="nav-item" id="nav-ents" onclick="route('ents')"><span class="nav-icon">ğŸ‘¥</span> å®¢æˆ·æƒç›Š (Entitlements)</div>
        </div>
        <div class="sidebar-footer">
            <div class="sidebar-btn btn-export" onclick="exportData()">ğŸ“¤ å¯¼å‡ºé…ç½® (Download)</div>
            <div class="sidebar-btn btn-import" onclick="document.getElementById('file-input').click()">ğŸ“¥ å¯¼å…¥é…ç½® (Restore)</div>
            <input type="file" id="file-input" style="display:none" accept=".json" onchange="importData(this)">
            <div class="sidebar-btn btn-settings" onclick="openModal('settings')">âš™ï¸ è®¾ç½® API Key</div>
            <div class="sidebar-btn btn-reset" onclick="resetData()">ğŸ—‘ï¸ é‡ç½®æ¼”ç¤ºæ•°æ®</div>
        </div>
    </div>

    <!-- Main -->
    <div class="main">
        <div class="header">
            <div class="page-title" id="page-title">å•†ä¸šåŒ–æ¨¡å‹è®¾è®¡æŒ‡å—</div>
            <div id="page-actions"></div>
        </div>
        <div class="content" id="main-content"></div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Feature Modal -->
<div class="mask" id="modal-feature">
    <div class="modal">
        <div class="modal-head"><span id="feat-modal-title">æ³¨å†Œ Feature</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">æŠ€æœ¯ ID (Key)</label><input class="form-input" id="feat-id" placeholder="feat_key"></div>
            <div class="form-group"><label class="form-label">åç§°</label><input class="form-input" id="feat-name"></div>
            <div class="form-group"><label class="form-label">æŠ€æœ¯è´Ÿè´£äºº</label><input class="form-input" id="feat-owner"></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveFeature()">ä¿å­˜</button></div>
    </div>
</div>

<!-- AI Feature Gen Modal -->
<div class="mask" id="modal-ai-feature">
    <div class="modal">
        <div class="modal-head"><span>âœ¨ AI èµ„äº§ç”Ÿæˆ</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">ä¸šåŠ¡é¢†åŸŸ</label><input class="form-input" id="ai-feat-topic"></div>
            <div class="form-group" id="ai-feat-loading" style="display:none; color:var(--primary);">ğŸ¤– æ­£åœ¨ç”Ÿæˆ...</div>
        </div>
        <div class="modal-foot"><button class="btn btn-ai" id="btn-ai-gen" onclick="generateAiFeatures()">å¼€å§‹ç”Ÿæˆ</button></div>
    </div>
</div>

<!-- Capability Modal -->
<div class="mask" id="modal-cap">
    <div class="modal">
        <div class="modal-head"><span id="cap-modal-title">å®šä¹‰ Capability</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">èƒ½åŠ›åç§°</label><input class="form-input" id="cap-name"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label class="form-label">ä½œç”¨åŸŸ</label><select class="form-select" id="cap-scope"><option value="WORKSPACE">å·¥ä½œåŒºçº§</option><option value="TENANT">ç§Ÿæˆ·çº§</option><option value="GLOBAL">å…¨åŸŸçº§</option></select></div>
                <div class="form-group" style="flex:1"><label class="form-label">å€¼ç±»å‹</label><select class="form-select" id="cap-type"><option value="BOOL">å¼€å…³å‹</option><option value="INT">æ•°å€¼å‹</option></select></div>
            </div>
            <div class="form-group"><label class="form-label">ç»‘å®šåº•å±‚ Feature</label><select class="form-select" id="cap-feat"></select></div>
            <div class="form-group"><label class="form-label">é€‚ç”¨äº§å“çº¿ä¸åˆ†ç±»</label><div class="multi-check-container" id="cap-prods-container"></div></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveCap()">ä¿å­˜</button></div>
    </div>
</div>

<!-- Rule Modal -->
<div class="mask" id="modal-rule">
    <div class="modal">
        <div class="modal-head"><span id="rule-modal-title">æ–°å»ºè§„åˆ™</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">è§„åˆ™å±‚çº§</label><select class="form-select" id="rule-level" onchange="updateRuleModalUI()"><option value="COMMERCIAL">å•†ä¸šå…³ç³»è§„åˆ™</option><option value="TECHNICAL">æŠ€æœ¯è§„åˆ™</option></select></div>
            <div class="form-group"><label class="form-label">ç±»å‹</label><select class="form-select" id="rule-type"><option value="DEPEND">ä¾èµ–</option><option value="MUTEX">äº’æ–¥</option></select></div>
            <div class="form-group"><label class="form-label">æè¿°</label><input class="form-input" id="rule-desc"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label class="form-label">ä¸»ä½“</label><select class="form-select" id="rule-src"></select></div>
                <div class="form-group" style="flex:1"><label class="form-label">ç›®æ ‡ (å¤šé€‰)</label><select class="form-select" id="rule-tgt" multiple size="4" style="height:100px"></select></div>
            </div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveRule()">ä¿å­˜</button></div>
    </div>
</div>

<!-- Product Modal -->
<div class="mask" id="modal-prod">
    <div class="modal">
        <div class="modal-head"><span id="prod-modal-title">æ–°å»ºäº§å“çº¿</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">äº§å“åç§°</label><input class="form-input" id="prod-name"></div>
            <div class="form-group"><label class="form-label">ä»£ç </label><input class="form-input" id="prod-code"></div>
            <div class="form-group"><label class="form-label">å›¾æ ‡</label><input class="form-input" id="prod-icon"></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveProduct()">ä¿å­˜</button></div>
    </div>
</div>

<!-- SKU Modal (Updated for Bundle) -->
<div class="mask" id="modal-sku">
    <div class="modal">
        <div class="modal-head"><span id="sku-modal-title">æ–°å»º SKU</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">åç§°</label><input class="form-input" id="sku-name"></div>
            <div class="form-group">
                <label class="form-label">æè¿°</label>
                <div style="display:flex; gap:8px;"><input class="form-input" id="sku-desc"><button class="btn btn-ai" onclick="generateSkuDesc()">âœ¨</button></div>
            </div>
            <div class="form-group"><label class="form-label">å®šä»·</label><div id="sku-pricing-container"></div><button class="btn btn-outline btn-sm" onclick="addPricingRow()">+ ä»·æ ¼æ–¹æ¡ˆ</button></div>
            <div class="form-group"><label class="form-label">ç±»å‹</label><select class="form-select" id="sku-type" onchange="toggleSkuType()"><option value="PLAN">ç‰ˆæœ¬</option><option value="ADDON">å¢å€¼åŒ…</option><option value="BUNDLE">æ‰“åŒ…å•†å“ (Bundle)</option></select></div>
            
            <!-- Plan Specific -->
            <div class="form-group" id="sku-level-group"><label class="form-label">Level</label><input type="number" class="form-input" id="sku-level" value="1"></div>
            
            <!-- Bundle Specific (New) -->
            <div class="form-group" id="sku-bundle-group" style="display:none;">
                <label class="form-label">åŒ…å« SKU (Bundle Content)</label>
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <select class="form-select" id="bundle-add-select"></select>
                    <button class="btn btn-primary btn-sm" onclick="addBundleItem()">æ·»åŠ </button>
                </div>
                <div class="multi-check-container" id="bundle-list-container" style="background:#f8fafc;"></div>
            </div>

        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveSku()">ä¿å­˜</button></div>
    </div>
</div>

<!-- Settings Modal -->
<div class="mask" id="modal-settings">
    <div class="modal">
        <div class="modal-head"><span>è®¾ç½®</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body"><div class="form-group"><label class="form-label">Gemini API Key</label><input type="password" class="form-input" id="settings-api-key"></div></div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button></div>
    </div>
</div>

<!-- Tenant Modal -->
<div class="mask" id="modal-new-t">
    <div class="modal">
        <div class="modal-head"><span id="tenant-modal-title">ç­¾çº¦æ–°å®¢æˆ·</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">ä¼ä¸šåç§°</label><input class="form-input" id="new-t-name"></div>
            <div id="new-t-initial-setup">
                <div class="form-group"><label class="form-label">é¦–è´­äº§å“</label><select class="form-select" id="new-t-prod" onchange="updateSkuOptions()"></select></div>
                <div class="form-group"><label class="form-label">é€‰æ‹© SKU</label><select class="form-select" id="new-t-sku"></select></div>
            </div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveNewTenant()">ä¿å­˜</button></div>
    </div>
</div>

<!-- Add Sub Modal (Growth) -->
<div class="mask" id="modal-add-sub">
    <div class="modal">
        <div class="modal-head"><span>å¢è´­äº§å“</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">å®¢æˆ·</label><input class="form-input" id="add-sub-tname" disabled></div>
            <div class="form-group"><label class="form-label">é€‰æ‹©äº§å“</label><select class="form-select" id="add-sub-prod" onchange="updateAddSubSkus()"></select></div>
            <div class="form-group"><label class="form-label">é€‰æ‹© SKU</label><select class="form-select" id="add-sub-sku"></select></div>
            <div class="form-group"><label class="form-label">å¸­ä½</label><input type="number" class="form-input" id="add-sub-seats" value="10"></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveAddSub()">ç¡®è®¤å¢è´­</button></div>
    </div>
</div>

<!-- Edit Sub Modal -->
<div class="mask" id="modal-edit-sub">
    <div class="modal">
        <div class="modal-head"><span>å˜æ›´æƒç›Š</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">å¸­ä½</label><input type="number" class="form-input" id="edit-sub-seats"></div>
            <div class="form-group"><label class="form-label">çŠ¶æ€</label><select class="form-select" id="edit-sub-status"><option value="Active">Active</option><option value="Suspended">Suspended</option></select></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveEditSub()">ä¿å­˜</button></div>
    </div>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
    <div style="padding:20px;border-bottom:1px solid #e2e8f0;font-weight:600;display:flex;justify-content:space-between;"><span id="drawer-title">é…ç½®</span><span style="cursor:pointer" onclick="closeDrawer()">âœ•</span></div>
    <div style="flex:1;overflow-y:auto;padding:0;" id="drawer-list"></div>
    <div style="padding:20px;border-top:1px solid #e2e8f0;text-align:right;"><button class="btn btn-primary" onclick="closeDrawer()">å®Œæˆ</button></div>
</div>
<div class="mask" id="drawer-overlay" onclick="closeDrawer()" style="z-index:150;"></div>


<script>
    // === API ===
    function getApiKey() { return localStorage.getItem('saas_gemini_key') || ""; }
    function saveSettings() { localStorage.setItem('saas_gemini_key', document.getElementById('settings-api-key').value); closeModals(); alert("Saved"); }
    async function callGemini(prompt) {
        const k = getApiKey();
        if(!k) return new Promise(r=>setTimeout(()=>r(prompt.includes("features")?'[{"name":"AI Feature","owner":"AI Team"}]':"ä¼ä¸šçº§èµ‹èƒ½æ–¹æ¡ˆ"),1000));
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]}) });
            const d = await r.json(); return d.candidates[0].content.parts[0].text;
        } catch(e) { alert("AI Error"); return null; }
    }
    async function generateAiFeatures() {
        const t = document.getElementById('ai-feat-topic').value;
        if(!t) return;
        document.getElementById('btn-ai-gen').disabled=true; document.getElementById('ai-feat-loading').style.display='block';
        const res = await callGemini(`Generate 5 SaaS features for "${t}" in JSON array format with "name" and "owner". Respond in Chinese.`);
        if(res) {
            try { 
                let clean = res;
                const start = clean.indexOf('[');
                const end = clean.lastIndexOf(']');
                if(start !== -1 && end !== -1) clean = clean.substring(start, end + 1);
                JSON.parse(clean).forEach(f=>features.push({id:'f'+Math.random(),name:f.name,owner:f.owner})); 
                saveData(); closeModals(); render(); 
            } catch(e){}
        }
        document.getElementById('btn-ai-gen').disabled=false; document.getElementById('ai-feat-loading').style.display='none';
    }
    async function generateSkuDesc() {
        const name = document.getElementById('sku-name').value;
        if(!name) return;
        const res = await callGemini(`Write a 20-char Chinese marketing copy for SaaS plan "${name}"`);
        if(res) document.getElementById('sku-desc').value = res.trim();
    }

    // === DATA ===
    const defaults = {
  "products": [
    { "id": "p_meego_prj", "name": "Meego Project", "code": "PRJ", "icon": "ğŸŒŸ" },
    { "id": "p_meego_ipd", "name": "Meego IPD", "code": "IPD", "icon": "âš™" },
    { "id": "p_meego_ltc", "name": "Meego LTC", "code": "LTC", "icon": "ğŸ’°" },
    { "id": "p_basic", "name": "Basic Platform", "code": "BSC", "icon": "B" },
    { "id": "p1764591867940", "name": "Meego AI", "code": "AI", "icon": "âœ¨" },
    { "id": "p_super", "name": "Meego One", "code": "ALL", "icon": "ğŸ’" }
  ],
  "features": [
    { "id": "feat_list", "name": "List/Board Views", "owner": "Core Team" },
    { "id": "feat_gantt", "name": "Gantt Chart", "owner": "Core Team" },
    { "id": "feat_calc", "name": "Calculated Fields", "owner": "Platform" },
    { "id": "feat_global_view", "name": "Global View", "owner": "Platform" },
    { "id": "feat_cross_org", "name": "Enterprise Interconnect", "owner": "Collaboration" },
    { "id": "feat_adv_perm", "name": "Advanced Permissions", "owner": "Identity" },
    { "id": "feat_security", "name": "Security Mgmt", "owner": "Sec Team" },
    { "id": "feat_automation", "name": "Automation Rules", "owner": "Automation" },
    { "id": "feat_branding", "name": "Brand Customization", "owner": "Frontend" },
    { "id": "feat_data_mig", "name": "Data Migration Service", "owner": "Ops" },
    { "id": "feat_custom_plugin", "name": "Custom Plugins", "owner": "Open API" }
  ],
  "capabilities": [
    { "id": "c_base_work", "name": "æ•°æ®å¯¼å…¥å¯¼å‡º", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "æ ¸å¿ƒåŠŸèƒ½", "p_meego_ipd": "æ ¸å¿ƒåŠŸèƒ½", "p_meego_ltc": "æ ¸å¿ƒåŠŸèƒ½" } },
    { "id": "c_gantt", "name": "é™„ä»¶èƒ½åŠ›", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "æ ¸å¿ƒåŠŸèƒ½", "p_meego_ipd": "æ ¸å¿ƒåŠŸèƒ½", "p_meego_ltc": "æ ¸å¿ƒåŠŸèƒ½" } },
    { "id": "c_sec_basic", "name": "æ’æœŸé»˜è®¤å€¼", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "æ ¸å¿ƒåŠŸèƒ½" } },
    { "id": "c_api", "name": "è®¡ç®—å­—æ®µ", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "é«˜çº§èµ„æº", "p_meego_ipd": "é«˜çº§èµ„æº", "p_meego_ltc": "é«˜çº§èµ„æº" } },
    { "id": "c_calc_field", "name": "è§†å›¾æ§ä»¶", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "é«˜çº§èµ„æº", "p_meego_ipd": "é«˜çº§èµ„æº", "p_meego_ltc": "é«˜çº§èµ„æº" } },
    { "id": "c_global_v", "name": "å…³è”å·¥ä½œé¡¹ä¿¡æ¯", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "é«˜çº§èµ„æº", "p_meego_ipd": "é«˜çº§èµ„æº", "p_meego_ltc": "é«˜çº§èµ„æº" } },
    { "id": "c_cross_org", "name": "æ ‘å½¢è§†å›¾", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ipd": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ltc": "è§†å›¾ä¸æŠ¥å‘Š" } },
    { "id": "c_adv_perm", "name": "åº¦é‡è§†å›¾", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ipd": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ltc": "è§†å›¾ä¸æŠ¥å‘Š" } },
    { "id": "c_auto_rule", "name": "å…¨æ™¯è§†å›¾", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ipd": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ltc": "è§†å›¾ä¸æŠ¥å‘Š" } },
    { "id": "c_branding", "name": "äººå‘˜ç”˜ç‰¹å›¾ï¼ˆè·¨ç©ºé—´ï¼‰", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ipd": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ltc": "è§†å›¾ä¸æŠ¥å‘Š" } },
    { "id": "c_migrate", "name": "åº¦é‡è®¡ç®—å­—æ®µ", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ipd": "è§†å›¾ä¸æŠ¥å‘Š", "p_meego_ltc": "è§†å›¾ä¸æŠ¥å‘Š" } },
    { "id": "c_plugins", "name": "è‡ªå®šä¹‰ç”¨æˆ·ç»„", "scope": "WORKSPACE", "fid": "", "prods": ["p_meego_prj"], "type": "BOOL", "categoryMap": { "p_meego_prj": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ipd": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ltc": "ç®¡ç†ä¸æ§åˆ¶" } },
    { "id": "c1764582876851", "name": "è‡ªå®šä¹‰å›¢é˜Ÿ", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ipd": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ltc": "ç®¡ç†ä¸æ§åˆ¶" }, "type": "BOOL" },
    { "id": "c1764582901677", "name": "å¸­ä½åˆ†ç»„ç®¡ç†", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ipd": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ltc": "ç®¡ç†ä¸æ§åˆ¶" }, "type": "BOOL" },
    { "id": "c1764582937003", "name": "é¡µé¢æ°´å°", "scope": "TENANT", "fid": "", "categoryMap": { "p_basic": "ç®¡ç†ä¸æ§åˆ¶" }, "type": "BOOL" },
    { "id": "c1764582972083", "name": "åº”ç”¨é£ä¹¦è®¿é—®ç­–ç•¥ç®¡æ§", "scope": "TENANT", "fid": "", "categoryMap": { "p_basic": "ç®¡ç†ä¸æ§åˆ¶" }, "type": "BOOL" },
    { "id": "c1764582992964", "name": "å¤åˆå­æ®µå­å­—æ®µæŸ¥çœ‹æƒé™", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ipd": "ç®¡ç†ä¸æ§åˆ¶", "p_meego_ltc": "ç®¡ç†ä¸æ§åˆ¶" }, "type": "BOOL" },
    { "id": "c1764588578413", "name": "é«˜çº§å¤šè¯­è¨€æ”¯æŒ", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764588599288", "name": "ç©ºé—´åŸºå‡†æ—¶åŒº", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764588617982", "name": "ä¼ä¸šäº’è”", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764588662369", "name": "ä¼ä¸šæ—¥å†", "scope": "GLOBAL", "fid": "", "categoryMap": { "p_basic": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764588683317", "name": "å·¥ä½œé¡¹é«˜çº§é…ç½®ï¼ˆå±‚çº§ç®¡ç†ï¼‰", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764589647152", "name": "çˆ¶å­å…³ç³»", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764589677318", "name": "èŠ‚ç‚¹/ä»»åŠ¡ä¾èµ–å…³ç³»", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764589701829", "name": "èŠ‚ç‚¹è‡ªå®šä¹‰æŒ‰é’®", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764589717409", "name": "å·¥ä½œé¡¹èµ„æºåº“", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764589745892", "name": "ç©ºé—´å…³è”/å…³ç³»ç®¡ç†/è·¨ç©ºé—´æˆæƒ", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "å·¥ä½œååŒ", "p_meego_ipd": "å·¥ä½œååŒ", "p_meego_ltc": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764589794115", "name": "WBSè®¡åˆ’è¡¨/æ³³é“å›¾/æ’ä»¶ï¼ˆIPDè¯„å®¡&æ–‡æ¡£åˆ›å»ºï¼‰ç­‰", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "è¿›é˜¶ç®¡ç†", "p_meego_ipd": "è¿›é˜¶ç®¡ç†" }, "type": "BOOL" },
    { "id": "c1764589829873", "name": "æ’ä»¶å¸‚åœº", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ipd": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ltc": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›" }, "type": "BOOL" },
    { "id": "c1764589844181", "name": "ä¼ä¸šè‡ªå»ºæ’ä»¶", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ipd": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ltc": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›" }, "type": "BOOL" },
    { "id": "c1764589860459", "name": "æ ‡å‡†API", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ipd": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ltc": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›" }, "type": "INT" },
    { "id": "c1764589876840", "name": "é«˜çº§API", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ipd": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ltc": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›" }, "type": "INT" },
    { "id": "c1764589898569", "name": "Webhook", "scope": "WORKSPACE", "fid": "", "categoryMap": { "p_meego_prj": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ipd": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ltc": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›" }, "type": "BOOL" },
    { "id": "c1764589927025", "name": "ä¼ä¸šæ¨¡æ¿å¸‚åœº", "scope": "TENANT", "fid": "", "categoryMap": { "p_meego_prj": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ipd": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›", "p_meego_ltc": "é›†æˆä¸å¼€æ”¾èƒ½åŠ›" }, "type": "BOOL" },
    { "id": "c1764589965561", "name": "æ•°æ®æŠ¥è¡¨", "scope": "TENANT", "fid": "", "categoryMap": { "p_basic": "è¿›é˜¶ç®¡ç†" }, "type": "BOOL" },
    { "id": "c1764589984325", "name": "è·¨å¢ƒäº’é€š", "scope": "TENANT", "fid": "", "categoryMap": { "p_basic": "å·¥ä½œååŒ" }, "type": "BOOL" },
    { "id": "c1764590014700", "name": "IPç™½åå•", "scope": "TENANT", "fid": "", "categoryMap": { "p_basic": "ç®¡ç†ä¸æ§åˆ¶" }, "type": "BOOL" }
  ],
  "rules": [
    { "id": "r1", "level": "COMMERCIAL", "type": "DEPEND", "desc": "ä¼ä¸šäº’è”éœ€åŸºç¡€å®‰å…¨", "src": "c_cross_org", "tgt": "c_sec_basic" },
    { "id": "r1764590169057", "level": "COMMERCIAL", "type": "DEPEND", "desc": "Project Premiumæ‰å¯ç”¨IPDé«˜çº§åŠŸèƒ½", "src": "s1764590114085", "tgt": "sku_mp_prm" },
    { "id": "r1764590302491", "level": "COMMERCIAL", "type": "DEPEND", "desc": "å“ç‰Œå®šåˆ¶ä»…æ”¯æŒPremiumåŠä»¥ä¸Šäº§å“", "src": "s1764590254369", "tgt": "sku_mp_prm" },
    { "id": "r1764591898971", "level": "COMMERCIAL", "type": "DEPEND", "desc": "AIä¸èƒ½ç‹¬ç«‹å­˜åœ¨", "src": "p1764591867940", "tgt": ["p_meego_prj", "p_meego_ipd", "p_meego_ltc"] },
    { "id": "r1764592044755", "level": "COMMERCIAL", "type": "DEPEND", "desc": "Basic Platformé«˜çº§åŠŸèƒ½-ä¹°èµ ", "src": "s1764591955877", "tgt": ["sku_mp_prm", "sku_mp_ent"] }
  ],
  "skus": [
    { "id": "sku_mp_std", "pid": "p_meego_prj", "type": "PLAN", "name": "Standard", "desc": "é€‚åˆå°å‹å›¢é˜Ÿå¿«é€Ÿä¸Šæ‰‹", "level": 1, "ents": { "c_base_work": true, "c_gantt": true, "c_sec_basic": true, "c_api": true, "c_auto_rule": 100 }, "pricing": [{ "mode": "PER_USER_MO", "price": 8 }] },
    { "id": "sku_mp_prm", "pid": "p_meego_prj", "type": "PLAN", "name": "Premium", "desc": "åŠ©åŠ›ä¸­å‹ä¼ä¸šé«˜æ•ˆåä½œ", "level": 2, "ents": { "c_base_work": true, "c_gantt": true, "c_sec_basic": true, "c_api": true, "c_calc_field": true, "c_global_v": true, "c_cross_org": true, "c_adv_perm": true, "c_auto_rule": 1000 }, "pricing": [{ "mode": "PER_USER_MO", "price": 12 }] },
    { "id": "sku_mp_ent", "pid": "p_meego_prj", "type": "PLAN", "name": "Enterprise", "desc": "å¤§å‹ç»„ç»‡çš„æ——èˆ°ä¹‹é€‰", "level": 3, "ents": { "c_base_work": true, "c_gantt": true, "c_sec_basic": true, "c_api": true, "c_calc_field": true, "c_global_v": true, "c_cross_org": true, "c_adv_perm": true, "c_auto_rule": 10000, "c_branding": true, "c_migrate": true, "c_plugins": true }, "pricing": [{ "mode": "CUSTOM", "price": 0 }] },
    { "id": "sku_mp_auto_plus", "pid": "p_meego_prj", "type": "ADDON", "name": "Auto+ Pack", "desc": "å¢åŠ  5000 æ¬¡è‡ªåŠ¨åŒ–æ‰§è¡Œ", "ents": { "c_auto_rule": 5000 }, "pricing": [{ "mode": "FLAT_MO", "price": 100 }] },
    { "id": "s1764590114085", "pid": "p_meego_prj", "type": "ADDON", "name": "IPDé«˜çº§åŠŸèƒ½", "desc": "", "pricing": [{ "mode": "PER_USER_MO", "price": 5 }], "level": 1, "ents": {} },
    { "id": "s1764590254369", "pid": "p_meego_prj", "type": "ADDON", "name": "å“ç‰Œå®šåˆ¶", "desc": "", "pricing": [{ "mode": "FLAT_YR", "price": 70000 }], "level": 1, "ents": {} },
    { "id": "s1764591939836", "pid": "p_basic", "type": "PLAN", "name": "Basic", "desc": "", "pricing": [{ "mode": "PER_USER_MO", "price": 0 }], "level": 1, "ents": {} },
    { "id": "s1764591955877", "pid": "p_basic", "type": "PLAN", "name": "Basic Premium", "desc": "", "pricing": [{ "mode": "PER_USER_MO", "price": 0 }], "level": 2, "ents": { "c1764582937003": true, "c1764582972083": true, "c1764590014700": true, "c1764588662369": true, "c1764589984325": true, "c1764589965561": true } },
    // BUNDLE Example: Meego One
    { 
        "id": "sku_super_all", 
        "pid": "p_super", 
        "type": "BUNDLE", 
        "name": "Meego One (Super License)", 
        "desc": "åŒ…å« Project Ent + IPD + LTC",
        "pricing": [{"mode":"PER_USER_MO","price":50}],
        "includedSkus": ["sku_mp_ent", "s1764590114085"], // References existing SKUs
        "ents": {}
    }
  ],
  "tenants": [
    { "id": "t1", "name": "Li Auto", "subs": [ { "skuId": "sku_mp_ent", "seats": 2000, "status": "Active", "end": "2026-01-01" } ] },
    { "id": "t2", "name": "NIO", "subs": [ { "skuId": "sku_mp_prm", "seats": 500, "status": "Active", "end": "2025-06-30" } ] }
  ]
};

    let products, features, capabilities, rules, skus, tenants;
    let tempBundleItems = [];

    function migrateData(data) {
        if (data.skus) {
            data.skus.forEach(s => {
                if (!s.includedSkus) s.includedSkus = [];
                if (Array.isArray(s.ents)) { const newEnts = {}; s.ents.forEach(c => newEnts[c] = true); s.ents = newEnts; }
            });
        }
        return data;
    }

    function initData() {
        if(localStorage.getItem('saas_demo_v42')) {
            let saved = JSON.parse(localStorage.getItem('saas_demo_v42'));
            saved = migrateData(saved);
            products = saved.products; features = saved.features; capabilities = saved.capabilities;
            rules = saved.rules; skus = saved.skus; tenants = saved.tenants;
        } else {
            resetData(false);
        }
    }

    function saveData() {
        const data = { products, features, capabilities, rules, skus, tenants };
        localStorage.setItem('saas_demo_v42', JSON.stringify(data));
    }

    function resetData(reload = true) {
        products = JSON.parse(JSON.stringify(defaults.products));
        features = JSON.parse(JSON.stringify(defaults.features));
        capabilities = JSON.parse(JSON.stringify(defaults.capabilities));
        rules = JSON.parse(JSON.stringify(defaults.rules));
        skus = JSON.parse(JSON.stringify(defaults.skus));
        tenants = JSON.parse(JSON.stringify(defaults.tenants));
        saveData();
        if(reload) location.reload();
    }

    // --- IMPORT / EXPORT LOGIC ---
    function exportData() {
        const data = { products, features, capabilities, rules, skus, tenants };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "saas_config.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let imported = JSON.parse(e.target.result);
                if(imported.products && imported.skus) {
                    imported = migrateData(imported); 
                    localStorage.setItem('saas_demo_v42', JSON.stringify(imported));
                    location.reload();
                } else { alert('Invalid config'); }
            } catch(err) { alert('Error parsing JSON'); }
        };
        reader.readAsText(file);
    }

    initData();

    // ================== 2. ROUTING ==================
    let currView = 'guide';
    let activeProdId = null;
    let editingId = null;
    let editSubRef = null;
    let drawerAddonId = null;
    let ruleTab = 'COMMERCIAL';
    let showAllCaps = false;

    function route(view) { currView = view; activeProdId = null; updateNav(); render(); }
    function enterProduct(pid) { currView = 'sku_studio'; activeProdId = pid; updateNav(); render(); }
    
    function updateNav() {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (currView === 'products' || currView === 'sku_studio') document.getElementById('nav-products').classList.add('active');
        else document.getElementById('nav-'+currView).classList.add('active');
    }

    function render() {
        const c = document.getElementById('main-content');
        const h = document.getElementById('page-title');
        const ha = document.getElementById('page-actions');
        c.innerHTML = ''; ha.innerHTML = '';

        if(currView === 'features') renderFeatures(c, h, ha);
        if(currView === 'caps') renderCaps(c, h, ha);
        if(currView === 'rules') renderRules(c, h, ha);
        if(currView === 'products') renderProducts(c, h, ha);
        if(currView === 'sku_studio') renderSkuStudio(c, h, ha);
        if(currView === 'ents') renderEnts(c, h, ha);
        if(currView === 'guide') renderGuide(c, h, ha);
    }

    // ... resolveName, getPriceDisplay ... 
    function resolveName(id, level) {
        if (Array.isArray(id)) return id.map(i => resolveName(i, level)).join(' æˆ– ');
        if(level === 'COMMERCIAL') {
            const p = products.find(x => x.id === id); if(p) return `äº§å“: ${p.name}`;
            const s = skus.find(x => x.id === id); if(s) return `SKU: ${s.name}`;
        } else {
            const f = features.find(x => x.id === id); if(f) return `Feat: ${f.name}`;
            const c = capabilities.find(x => x.id === id); if(c) return `Cap: ${c.name}`;
        }
        return id;
    }
    function getPriceDisplay(sku) {
        if(!sku.pricing || sku.pricing.length === 0) return 'æœªå®šä»·';
        const labels = { 'PER_USER_MO': '/äºº/æœˆ', 'PER_USER_YR': '/äºº/å¹´', 'FLAT_MO': '/æœˆ', 'FLAT_YR': '/å¹´', 'ONE_TIME': 'ä¸€æ¬¡æ€§', 'CUSTOM': 'è¯¢ä»·' };
        return sku.pricing.map(p => p.mode === 'CUSTOM' ? 'è¯¢ä»·' : `Â¥${p.price}${labels[p.mode]||''}`).join(' | ');
    }
    
    // ================== 3. VIEWS ==================

    function renderGuide(c, h, ha) {
        h.innerText = 'æ¨¡å‹è®¾è®¡æŒ‡å—';
        c.innerHTML = `<div class="guide-section"><div class="guide-title">V42: Super Licensing & Cross-Product</div><div class="guide-box">V42 å¼•å…¥äº† <strong>Bundle SKU</strong> æ¦‚å¿µï¼Œå…è®¸ä¸€ä¸ª SKU åŒ…å«å…¶ä»–äº§å“çš„ SKUã€‚åŒæ—¶æ”¯æŒåœ¨çŸ©é˜µä¸­è·¨äº§å“çº¿æˆäºˆæƒç›Šã€‚</div></div>`;
    }
    function renderFeatures(c, h, ha) { h.innerText='Feature Registry'; c.innerHTML='(Feature List)'; } // Placeholder
    function renderCaps(c, h, ha) { h.innerText='Capabilities'; c.innerHTML='(Cap List)'; } // Placeholder
    function renderRules(c, h, ha) { h.innerText='Rules'; c.innerHTML='(Rule List)'; } // Placeholder
    function renderProducts(c, h, ha) {
        h.innerText = 'äº§å“ç®¡ç† (Products)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('prod')">+ æ–°å»ºäº§å“</button>`;
        c.innerHTML = `<div class="prod-grid">${products.map(p => `
            <div class="prod-card" onclick="enterProduct('${p.id}')">
                <div class="prod-actions" onclick="event.stopPropagation()"><button class="btn btn-icon" onclick="openModal('prod','${p.id}')">âœï¸</button><button class="btn btn-icon danger" onclick="deleteItem('prod','${p.id}')">ğŸ—‘ï¸</button></div>
                <div class="prod-icon">${p.icon}</div>
                <div style="font-weight:600; font-size:16px;">${p.name}</div>
                <div style="margin-top:16px; font-size:13px; color:#64748b;">
                    ${skus.filter(s=>s.pid===p.id && s.type==='BUNDLE').length} Bundles, 
                    ${skus.filter(s=>s.pid===p.id && s.type!=='BUNDLE').length} SKUs
                </div>
            </div>`).join('')}</div>`;
    }
    function renderEnts(c, h, ha) { h.innerText='Entitlements'; c.innerHTML='(Ents List)'; } // Placeholder

    function renderSkuStudio(c, h, ha) {
        const prod = products.find(p => p.id === activeProdId);
        h.innerHTML = `<span style="color:#64748b; cursor:pointer" onclick="route('products')">äº§å“ç®¡ç†</span> / ${prod.name}`;
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('sku')">+ SKU</button>`;

        const plans = skus.filter(s => s.pid === activeProdId && s.type === 'PLAN');
        const bundles = skus.filter(s => s.pid === activeProdId && s.type === 'BUNDLE'); // Filter Bundles
        
        let prodCaps;
        if (showAllCaps) { prodCaps = capabilities; } 
        else { prodCaps = capabilities.filter(c => (c.categoryMap && c.categoryMap[activeProdId])); }
        
        // Group caps by category
        const catGroups = {};
        prodCaps.forEach(c => { const cat = (c.categoryMap && c.categoryMap[activeProdId]) || 'æœªåˆ†ç±»'; if(!catGroups[cat]) catGroups[cat] = []; catGroups[cat].push(c); });
        const categories = Object.keys(catGroups);

        c.innerHTML = `
        <div style="margin-bottom:10px;"><label><input type="checkbox" ${showAllCaps?'checked':''} onchange="toggleShowAllCaps()"> æ˜¾ç¤ºè·¨äº§å“æƒç›Š</label></div>
        <h3>Plan Matrix</h3>
        <div class="matrix-container">
            <table>
                <thead><tr><th style="background:white; min-width:200px;">èƒ½åŠ›åŸå­</th>
                ${plans.map(p => `<th><div class="sku-header-content"><div class="sku-header-row">${p.name} <div class="sku-actions"><button class="btn btn-icon" onclick="openModal('sku','${p.id}')">âœï¸</button></div></div><div class="sku-price-tag">${getPriceDisplay(p)}</div></div></th>`).join('')}
                </tr></thead>
                <tbody>
                ${categories.map(cat => `<tr><td colspan="${plans.length+1}" class="matrix-cat-row">${cat}</td></tr>
                    ${catGroups[cat].map(cap => `<tr><td><b>${cap.name}</b><br><span style="font-size:11px; color:#999">${cap.scope}</span>${cap.type==='INT'?'<span style="font-size:11px; color:#7e22ce; margin-left:4px;">(æ•°å€¼)</span>':''}</td>
                    ${plans.map(p => {
                        const val = p.ents[cap.id];
                        let cell = cap.type==='INT' ? (val?`<div class="qty-badge">${val}</div>`:`<div class="qty-badge empty">-</div>`) : `<div class="check-box ${val?'checked':''}"></div>`;
                        return `<td class="matrix-cell" onclick="toggleEnt('${p.id}','${cap.id}', '${cap.type}')">${cell}</td>`;
                    }).join('')}
                    </tr>`).join('')}
                `).join('')}
                </tbody>
            </table>
        </div>
        
        <!-- NEW: Bundle Section -->
        ${bundles.length > 0 ? `
            <h3 style="margin-top:24px;">Bundles (Super Licenses)</h3>
            <div class="addon-grid">
                ${bundles.map(b => `
                <div class="addon-card" style="border-color:#4338ca; background:#eef2ff;">
                    <div>
                        <div style="font-weight:600; font-size:15px;">${b.name}</div>
                        <div class="addon-card-actions"><button class="btn btn-icon" onclick="openModal('sku','${b.id}')">âœï¸</button></div>
                        <div style="font-size:12px; margin-top:8px;">
                            <strong>Includes:</strong><br>
                            ${b.includedSkus.map(sid => {
                                const s = skus.find(x=>x.id===sid);
                                const p = s ? products.find(x=>x.id===s.pid) : null;
                                return `<div class="bundle-item">${p?p.code:''} - ${s?s.name:sid}</div>`;
                            }).join('')}
                        </div>
                         <div class="addon-price" style="margin-top:8px;">${getPriceDisplay(b)}</div>
                    </div>
                    <span class="tag tag-bundle" style="position:absolute; bottom:10px; right:10px;">BUNDLE</span>
                </div>
                `).join('')}
            </div>
        ` : ''}
        `;
    }
    
    function toggleShowAllCaps() { showAllCaps = !showAllCaps; render(); }
    
    function toggleEnt(sid, cid, type) {
        const s = skus.find(x=>x.id===sid);
        if(!s.ents[cid]) {
             if(type==='INT') { const v=prompt("æ•°é‡","100"); if(v) s.ents[cid]=parseInt(v); }
            else s.ents[cid]=true;
        } else delete s.ents[cid];
        saveData(); render();
    }

    // ================== 5. MODAL LOGIC ==================
    
    function toggleSkuType() {
        const type = document.getElementById('sku-type').value;
        document.getElementById('sku-level-group').style.display = type==='PLAN'?'block':'none';
        document.getElementById('sku-bundle-group').style.display = type==='BUNDLE'?'block':'none';
    }
    
    function addBundleItem(val=null) {
        const container = document.getElementById('bundle-list-container');
        const sel = document.getElementById('bundle-add-select');
        const sid = val || sel.value;
        if(!sid) return;
        if(tempBundleItems.includes(sid)) return; // Prevent dupes
        tempBundleItems.push(sid);
        
        const s = skus.find(x=>x.id===sid);
        const p = products.find(x=>x.id===s.pid);
        const div = document.createElement('div');
        div.className = 'bundle-item';
        div.innerHTML = `<span>${p.code} - ${s.name}</span> <button class="btn btn-icon danger" style="margin-left:auto;" onclick="removeBundleItem('${sid}', this)">âœ•</button>`;
        container.appendChild(div);
    }
    
    function removeBundleItem(sid, btn) {
        tempBundleItems = tempBundleItems.filter(x => x !== sid);
        btn.parentElement.remove();
    }

    function openModal(type, id=null) {
        document.querySelectorAll('.mask').forEach(e=>e.style.display='none');
        document.getElementById('modal-'+type).style.display='flex';
        editingId = id;
        
        if(type === 'sku') {
            const item = id ? skus.find(x=>x.id===id) : {name:'', type:'PLAN', pricing:[], includedSkus:[]};
            document.getElementById('sku-name').value = item.name;
            document.getElementById('sku-type').value = item.type;
            toggleSkuType();
            
            // Fill bundle selector with ALL plans/addons from ALL products
            const bundleSel = document.getElementById('bundle-add-select');
            bundleSel.innerHTML = skus.filter(s=>s.type!=='BUNDLE' && s.id!==id).map(s=> { 
                const p = products.find(x=>x.id===s.pid); 
                return `<option value="${s.id}">${p.code} - ${s.name}</option>`; 
            }).join('');
            
            // Init Bundle List
            tempBundleItems = [];
            document.getElementById('bundle-list-container').innerHTML = '';
            if(item.includedSkus) item.includedSkus.forEach(sid => addBundleItem(sid));
            
             // Pricing
            const pContainer = document.getElementById('sku-pricing-container');
            pContainer.innerHTML = '';
            if(item.pricing && item.pricing.length) item.pricing.forEach(p=>addPricingRow(p.mode, p.price));
            else addPricingRow();
        }
        // (Other modal logic omitted for brevity, assumed same as V41)
    }
    
    function saveSku() {
        const name = document.getElementById('sku-name').value;
        const type = document.getElementById('sku-type').value;
        if(name) {
            let s;
            if(editingId) { s = skus.find(x=>x.id===editingId); s.name=name; s.type=type; } 
            else { s = {id:'s'+Date.now(), pid:activeProdId, type, name, ents:{}}; skus.push(s); }
            
            if(type === 'BUNDLE') s.includedSkus = [...tempBundleItems];
             // Pricing save logic...
            saveData(); closeModals(); render();
        }
    }
    
    function closeModals() { document.querySelectorAll('.mask').forEach(e=>e.style.display='none'); }
    function addPricingRow(mode='', price='') {
        const container = document.getElementById('sku-pricing-container');
        const div = document.createElement('div'); div.className = 'pricing-row';
        div.innerHTML = `<select class="form-select" style="flex:1"><option value="PER_USER_MO">æ¯äºº/æœˆ</option><option value="FLAT_YR">å›ºå®š/å¹´</option></select><input type="number" class="form-input" style="flex:1" value="${price}"><button class="btn btn-icon danger" onclick="this.parentElement.remove()">âœ•</button>`;
        container.appendChild(div);
        if(mode) div.querySelector('select').value = mode;
    }
    // Other CRUD functions same as V41
    
    route('products');
</script>
</body>
</html>