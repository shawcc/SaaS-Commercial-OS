<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Commercial OS V13 - The Masterpiece</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-sidebar: #0f172a;
            --bg-app: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --sidebar-w: 260px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #cbd5e1; height: 100vh; display: flex; justify-content: center; align-items: center;
            color: var(--text-main);
        }

        .app-window {
            width: 1500px; height: 950px; background: var(--bg-app); border-radius: 12px;
            display: flex; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        /* --- Sidebar --- */
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); color: #cbd5e1; display: flex; flex-direction: column; flex-shrink: 0;}
        .logo-box { height: 64px; border-bottom: 1px solid #1e293b; display: flex; align-items: center; padding: 0 24px; font-weight: 700; font-size: 16px; color: white; gap: 10px;}
        
        .nav-group { padding: 24px 16px 0; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 8px; padding-left: 12px; }
        .nav-item {
            padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; transition: 0.2s;
        }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-icon { margin-right: 10px; width: 20px; text-align: center; }

        /* --- Main Content --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 64px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; flex-shrink: 0;}
        .page-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .content { flex: 1; overflow-y: auto; padding: 32px; }

        /* --- UI Kit --- */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-weight: 600; font-size: 15px; }
        .card-body { padding: 20px; }

        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f1f5f9; }
        .btn-icon { padding: 4px 8px; background: transparent; color: var(--text-sub); font-size: 14px; }
        .btn-icon:hover { color: var(--text-main); background: #f1f5f9; border-radius: 4px; }
        .btn-danger { color: var(--danger); }
        .btn-danger:hover { background: #fef2f2; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 24px; font-size: 12px; color: var(--text-sub); border-bottom: 1px solid var(--border); background: #f8fafc; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        td { padding: 14px 24px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:last-child td { border-bottom: none; }

        /* Tags */
        .tag { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-block; }
        .tag-blue { background: #eff6ff; color: #1d4ed8; }
        .tag-orange { background: #fff7ed; color: #c2410c; }
        .tag-purple { background: #faf5ff; color: #7e22ce; }
        .tag-green { background: #dcfce7; color: #166534; }
        .tag-red { background: #fef2f2; color: #991b1b; }

        /* --- Product Hierarchy Views --- */
        .prod-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
        .prod-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: 0.2s; position: relative; display: flex; flex-direction: column; }
        .prod-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: var(--primary); }
        .prod-icon { width: 48px; height: 48px; background: #eff6ff; color: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 16px; }
        .prod-actions { position: absolute; top: 16px; right: 16px; opacity: 0; transition: 0.2s; }
        .prod-card:hover .prod-actions { opacity: 1; }

        /* --- SKU Matrix --- */
        .matrix-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: white; }
        .matrix-cell { text-align: center; cursor: pointer; transition: 0.2s; }
        .matrix-cell:hover { background: #f8fafc; }
        .check-box { width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 4px; margin: 0 auto; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .check-box.checked { background: var(--primary); border-color: var(--primary); color: white; }
        .check-box.checked::after { content: 'âœ“'; font-size: 12px; font-weight: bold; }
        
        .sku-header-actions { visibility: hidden; margin-left: 8px; display: inline-flex; gap: 4px; }
        th:hover .sku-header-actions { visibility: visible; }

        /* --- Add-on Cards --- */
        .addon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .addon-card { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 20px; position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 140px; }
        .addon-card:hover { border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .addon-actions { margin-top: auto; padding-top: 12px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }

        /* --- Drawer & Modals --- */
        .mask { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; }
        
        .modal { background: white; width: 500px; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; }
        .modal-head { padding: 16px 24px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; }
        .modal-body { padding: 24px; }
        .modal-foot { padding: 16px 24px; border-top: 1px solid var(--border); text-align: right; background: #f8fafc; }
        
        .drawer { position: absolute; top:0; right:0; bottom:0; width: 500px; background: white; z-index: 200; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; box-shadow: -10px 0 25px rgba(0,0,0,0.1); }
        .drawer.open { transform: translateX(0); }
        .drawer-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 16px; background: #f8fafc; }
        .drawer-body { flex: 1; overflow-y: auto; padding: 0; background: white; }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-sub); }
        .form-input, .form-select { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }
    </style>
</head>
<body>

<div class="app-window">
    
    <div class="sidebar">
        <div class="logo-box">ğŸ’  SaaS Commercial OS</div>

        <div class="nav-group">
            <div class="nav-label">Layer 1 & 2: èµ„äº§å®šä¹‰</div>
            <div class="nav-item active" id="nav-features" onclick="route('features')">
                <span class="nav-icon">ğŸ”§</span> æŠ€æœ¯ç‰¹æ€§ (Features)
            </div>
            <div class="nav-item" id="nav-caps" onclick="route('caps')">
                <span class="nav-icon">ğŸ“¦</span> å•†ä¸šèƒ½åŠ› (Capabilities)
            </div>
            <div class="nav-item" id="nav-rules" onclick="route('rules')">
                <span class="nav-icon">ğŸ›¡ï¸</span> è§„åˆ™å¼•æ“ (Rules)
            </div>
        </div>

        <div class="nav-group">
            <div class="nav-label">Layer 3: å•†å“åŒ…è£…</div>
            <div class="nav-item" id="nav-products" onclick="route('products')">
                <span class="nav-icon">ğŸ·ï¸</span> äº§å“çº¿ç®¡ç†
            </div>
        </div>
        
        <div class="nav-group">
            <div class="nav-label">Layer 4: å±¥çº¦è¿è¥</div>
            <div class="nav-item" id="nav-ents" onclick="route('ents')">
                <span class="nav-icon">ğŸ‘¥</span> å®¢æˆ·æƒç›Šç®¡ç†
            </div>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <div class="page-title" id="page-title">Feature Registry</div>
            <div id="page-actions"></div>
        </div>
        <div class="content" id="main-content">
            </div>
    </div>
</div>

<div class="mask" id="modal-feature">
    <div class="modal">
        <div class="modal-head"><span>æ³¨å†Œ Feature</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">æŠ€æœ¯ ID</label><input class="form-input" id="feat-id" placeholder="feat_key"></div>
            <div class="form-group"><label class="form-label">åç§°</label><input class="form-input" id="feat-name"></div>
            <div class="form-group"><label class="form-label">æŠ€æœ¯è´Ÿè´£äºº</label><input class="form-input" id="feat-owner"></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveFeature()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-cap">
    <div class="modal">
        <div class="modal-head"><span>å®šä¹‰ Capability</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">èƒ½åŠ›åç§°</label><input class="form-input" id="cap-name"></div>
            <div class="form-group"><label class="form-label">ä½œç”¨åŸŸ</label>
                <select class="form-select" id="cap-scope">
                    <option value="WORKSPACE">å·¥ä½œåŒºçº§ (Workspace)</option>
                    <option value="TENANT">ç§Ÿæˆ·çº§ (Tenant)</option>
                    <option value="GLOBAL">å…¨åŸŸçº§ (Global)</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">ç»‘å®š Feature</label><select class="form-select" id="cap-feat"></select></div>
            <div class="form-group"><label class="form-label">å½’å±äº§å“çº¿</label><select class="form-select" id="cap-prod"></select></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveCap()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-rule">
    <div class="modal">
        <div class="modal-head"><span>æ–°å»ºè§„åˆ™</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">ç±»å‹</label>
                <select class="form-select" id="rule-type">
                    <option value="MUTEX">æŠ€æœ¯äº’æ–¥ (Mutex)</option>
                    <option value="DEPEND">ä¾èµ–å…³ç³» (Dependency)</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">æè¿°</label><input class="form-input" id="rule-desc"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label class="form-label">æº</label><select class="form-select" id="rule-src"></select></div>
                <div class="form-group" style="flex:1"><label class="form-label">ç›®æ ‡</label><select class="form-select" id="rule-tgt"></select></div>
            </div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveRule()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-prod">
    <div class="modal">
        <div class="modal-head"><span id="prod-modal-title">æ–°å»ºäº§å“çº¿</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">äº§å“åç§°</label><input class="form-input" id="prod-name"></div>
            <div class="form-group"><label class="form-label">äº§å“ä»£ç </label><input class="form-input" id="prod-code"></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveProduct()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-sku">
    <div class="modal">
        <div class="modal-head"><span id="sku-modal-title">æ–°å»º SKU</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">å½’å±äº§å“</label><input class="form-input" id="sku-prod-disp" disabled style="background:#f1f5f9;"></div>
            <div class="form-group"><label class="form-label">SKU åç§°</label><input class="form-input" id="sku-name"></div>
            <div class="form-group"><label class="form-label">ç±»å‹</label>
                <select class="form-select" id="sku-type"><option value="PLAN">ç‰ˆæœ¬ (Plan)</option><option value="ADDON">å¢å€¼åŒ… (Add-on)</option></select>
            </div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveSku()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-sub">
    <div class="modal">
        <div class="modal-head"><span>æƒç›Šå˜æ›´</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div style="margin-bottom:15px; background:#f1f5f9; padding:10px; border-radius:6px; font-size:13px;">
                å®¢æˆ·: <strong id="sub-tenant"></strong><br>
                å•†å“: <strong id="sub-sku"></strong>
            </div>
            <div class="form-group"><label class="form-label">å¸­ä½ (Seats)</label><input type="number" class="form-input" id="sub-seats"></div>
            <div class="form-group"><label class="form-label">æœ‰æ•ˆæœŸ</label><input type="date" class="form-input" id="sub-date"></div>
            <div class="form-group"><label class="form-label">çŠ¶æ€</label><select class="form-select" id="sub-status"><option value="Active">Active</option><option value="Suspended">Suspended</option></select></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveSub()">ä¿å­˜</button></div>
    </div>
</div>

<div class="mask" id="modal-new-t">
    <div class="modal">
        <div class="modal-head"><span>ç­¾çº¦æ–°å®¢æˆ·</span><span style="cursor:pointer" onclick="closeModals()">âœ•</span></div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">ä¼ä¸šåç§°</label><input class="form-input" id="new-t-name"></div>
            <div class="form-group"><label class="form-label">åˆå§‹å•†å“</label><select class="form-select" id="new-t-sku"></select></div>
            <div class="form-group"><label class="form-label">åˆå§‹å¸­ä½</label><input type="number" class="form-input" id="new-t-seats" value="10"></div>
        </div>
        <div class="modal-foot"><button class="btn btn-primary" onclick="saveNewTenant()">ç­¾çº¦</button></div>
    </div>
</div>

<div class="drawer" id="drawer">
    <div class="drawer-head"><span id="drawer-title">é…ç½® Add-on</span><span style="cursor:pointer" onclick="closeDrawer()">âœ•</span></div>
    <div style="padding:16px; border-bottom:1px solid #e2e8f0; background:white;">
        <input class="form-input" placeholder="ğŸ” æœç´¢..." oninput="renderDrawerList(this.value)">
        <div style="margin-top:10px; display:flex; gap:8px; font-size:13px; cursor:pointer;" onclick="toggleDrawerFilter()">
            <input type="checkbox" id="drawer-check" style="pointer-events:none;"> <span>åªæ˜¾ç¤ºå·²åŒ…å«</span>
        </div>
    </div>
    <div class="drawer-body" id="drawer-list"></div>
    <div style="padding:16px; border-top:1px solid #e2e8f0; text-align:right;">
        <button class="btn btn-primary" onclick="closeDrawer()">å®Œæˆé…ç½®</button>
    </div>
</div>
<div class="mask" id="drawer-overlay" onclick="closeDrawer()" style="z-index:150;"></div>

<script>
    // ================== DATA MODEL ==================
    let products = [
        { id: 'p1', name: 'HyperCRM', code: 'CRM' },
        { id: 'p2', name: 'HyperHRM', code: 'HRM' }
    ];
    let features = [
        { id: 'f1', name: 'Kanban Core', owner: 'Board Team' },
        { id: 'f2', name: 'Adv Roadmap', owner: 'Roadmap Team' },
        { id: 'f3', name: 'AI Engine', owner: 'AI Lab' }
    ];
    let capabilities = [
        { id: 'c1', name: 'æ ‡å‡†çœ‹æ¿', scope: 'WORKSPACE', fid: 'f1', prod: 'p1' },
        { id: 'c2', name: 'é«˜çº§è·¯çº¿å›¾', scope: 'WORKSPACE', fid: 'f2', prod: 'p1' },
        { id: 'c3', name: 'AI åŠ©æ‰‹', scope: 'WORKSPACE', fid: 'f3', prod: 'p1' },
        { id: 'c4', name: 'ä¼ä¸šSSO', scope: 'TENANT', fid: null, prod: 'p1' },
        { id: 'c5', name: 'å‘˜å·¥æ¡£æ¡ˆ', scope: 'WORKSPACE', fid: null, prod: 'p2' }
    ];
    let rules = [
        { id: 'r1', type: 'DEPEND', desc: 'AIä¾èµ–é«˜çº§ç‰ˆ', src: 'c3', tgt: 'c2' }
    ];
    let skus = [
        { id: 's1', pid: 'p1', type: 'PLAN', name: 'Standard', ents: ['c1'] },
        { id: 's2', pid: 'p1', type: 'PLAN', name: 'Professional', ents: ['c1', 'c2', 'c4'] },
        { id: 's3', pid: 'p1', type: 'ADDON', name: 'AI Pack', ents: ['c3'] }
    ];
    let tenants = [
        { id: 't1', name: 'Acme Corp', subs: [{ skuId: 's2', seats: 200, status: 'Active', end: '2025-12-31' }] }
    ];

    // ================== STATE ==================
    let currView = 'features';
    let activeProdId = null;
    let editItem = null;
    let editSubRef = null;
    let drawerAddonId = null;
    let drawerFilter = false;

    // ================== ROUTING ==================
    function route(view) {
        currView = view;
        activeProdId = null;
        updateNav();
        render();
    }
    
    function enterProduct(pid) {
        currView = 'sku_studio';
        activeProdId = pid;
        updateNav();
        render();
    }

    function updateNav() {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (currView === 'products' || currView === 'sku_studio') document.getElementById('nav-products').classList.add('active');
        else document.getElementById('nav-'+currView).classList.add('active');
    }

    function render() {
        const c = document.getElementById('main-content');
        const h = document.getElementById('page-title');
        const ha = document.getElementById('page-actions');
        c.innerHTML = ''; ha.innerHTML = '';

        if(currView === 'features') renderFeatures(c, h, ha);
        if(currView === 'caps') renderCaps(c, h, ha);
        if(currView === 'rules') renderRules(c, h, ha);
        if(currView === 'products') renderProducts(c, h, ha);
        if(currView === 'sku_studio') renderSkuStudio(c, h, ha);
        if(currView === 'ents') renderEnts(c, h, ha);
    }

    // ================== VIEWS ==================
    
    // 1. Features
    function renderFeatures(c, h, ha) {
        h.innerText = 'Feature Registry (æŠ€æœ¯èµ„äº§)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('feature')">+ æ³¨å†Œ Feature</button>`;
        c.innerHTML = `
        <div class="card">
            <table>
                <thead><tr><th>ID</th><th>åç§°</th><th>Owner</th><th>æ“ä½œ</th></tr></thead>
                <tbody>${features.map(f => `
                    <tr>
                        <td><code style="background:#f1f5f9; padding:2px 6px; border-radius:4px;">${f.id}</code></td>
                        <td style="font-weight:500">${f.name}</td>
                        <td>${f.owner}</td>
                        <td><button class="btn btn-icon" onclick="deleteItem('feature','${f.id}')">ğŸ—‘ï¸</button></td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>`;
    }

    // 2. Capabilities
    function renderCaps(c, h, ha) {
        h.innerText = 'Capability Library (å•†ä¸šèƒ½åŠ›)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('cap')">+ å®šä¹‰ Capability</button>`;
        c.innerHTML = `
        <div class="card">
            <table>
                <thead><tr><th>åç§°</th><th>ä½œç”¨åŸŸ</th><th>ç»‘å®š Feature</th><th>å½’å±äº§å“</th><th>æ“ä½œ</th></tr></thead>
                <tbody>${capabilities.map(cap => {
                    const f = features.find(x => x.id === cap.fid);
                    const p = products.find(x => x.id === cap.prod);
                    const tag = cap.scope==='TENANT'?'tag-blue':(cap.scope==='GLOBAL'?'tag-purple':'tag-orange');
                    return `
                    <tr>
                        <td style="font-weight:600">${cap.name}</td>
                        <td><span class="tag ${tag}">${cap.scope}</span></td>
                        <td>${f ? f.name : '<span style="color:#ccc">-</span>'}</td>
                        <td>${p ? p.code : '-'}</td>
                        <td><button class="btn btn-icon" onclick="deleteItem('cap','${cap.id}')">ğŸ—‘ï¸</button></td>
                    </tr>`;
                }).join('')}
                </tbody>
            </table>
        </div>`;
    }

    // 3. Rules
    function renderRules(c, h, ha) {
        h.innerText = 'Rule Engine (è§„åˆ™å¼•æ“)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openModal('rule')">+ æ–°å»ºè§„åˆ™</button>`;
        c.innerHTML = `<div class="card" style="padding:24px;">${rules.map(r => {
            const s = capabilities.find(x=>x.id===r.src)?.name || r.src;
            const t = capabilities.find(x=>x.id===r.tgt)?.name || r.tgt;
            return `
            <div style="border:1px solid #e2e8f0; padding:16px; border-radius:8px; margin-bottom:12px; display:flex; align-items:center;">
                <span class="tag ${r.type==='MUTEX'?'tag-red':'tag-blue'}" style="width:60px; text-align:center; margin-right:16px;">${r.type}</span>
                <div style="flex:1;">
                    <div style="font-weight:600;">${r.desc}</div>
                    <div style="font-size:12px; color:#64748b;">${s} -> ${t}</div>
                </div>
                <button class="btn btn-icon" onclick="deleteItem('rule','${r.id}')">ğŸ—‘ï¸</button>
            </div>`;
        }).join('')}</div>`;
    }

    // 4. Products (Hierarchy Root)
    function renderProducts(c, h, ha) {
        h.innerText = 'äº§å“çº¿ç®¡ç† (Product Lines)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openProdModal()">+ æ–°å»ºäº§å“çº¿</button>`;
        c.innerHTML = `<div class="prod-grid">${products.map(p => `
            <div class="prod-card" onclick="enterProduct('${p.id}')">
                <div class="prod-actions" onclick="event.stopPropagation()">
                    <button class="btn btn-icon" onclick="openProdModal('${p.id}')">âœï¸</button>
                    <button class="btn btn-icon" style="color:#ef4444" onclick="deleteItem('prod','${p.id}')">ğŸ—‘ï¸</button>
                </div>
                <div class="prod-icon">${p.name[0]}</div>
                <div style="font-weight:600; font-size:16px; margin-bottom:4px;">${p.name}</div>
                <div style="font-size:12px; color:#64748b; background:#f1f5f9; display:inline-block; padding:2px 6px; border-radius:4px;">${p.code}</div>
            </div>`).join('')}</div>`;
    }

    // 5. SKU Studio (Child View)
    function renderSkuStudio(c, h, ha) {
        const prod = products.find(p => p.id === activeProdId);
        h.innerHTML = `<span style="color:#64748b; cursor:pointer" onclick="route('products')">äº§å“çº¿</span> <span style="margin:0 8px; color:#cbd5e1">/</span> ${prod.name}`;
        ha.innerHTML = `<button class="btn btn-primary" onclick="openSkuModal()">+ æ–°å»º SKU</button>`;

        const pPlans = skus.filter(s => s.pid === activeProdId && s.type === 'PLAN');
        const pAddons = skus.filter(s => s.pid === activeProdId && s.type === 'ADDON');
        const pCaps = capabilities.filter(cap => cap.prod === activeProdId);

        let html = `
        <div style="margin-bottom:32px;">
            <h3 style="font-size:15px; margin-bottom:12px;">Plan Matrix (ç‰ˆæœ¬çŸ©é˜µ)</h3>
            <div class="matrix-container">
                <table>
                    <thead>
                        <tr>
                            <th style="background:white; min-width:200px;">èƒ½åŠ›åŸå­</th>
                            ${pPlans.map(p => `
                                <th>
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        ${p.name}
                                        <div class="sku-header-actions">
                                            <button class="btn btn-icon" onclick="openSkuModal('${p.id}')">âœï¸</button>
                                            <button class="btn btn-icon" style="color:red" onclick="deleteItem('sku','${p.id}')">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                </th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>${pCaps.map(cap => `
                        <tr>
                            <td>
                                <div style="font-weight:500">${cap.name}</div>
                                <div style="font-size:11px; color:#94a3b8;">${cap.scope}</div>
                            </td>
                            ${pPlans.map(p => {
                                const checked = p.ents.includes(cap.id);
                                return `<td class="matrix-cell" onclick="toggleEnt('${p.id}', '${cap.id}')">
                                    <div class="check-box ${checked?'checked':''}"></div>
                                </td>`;
                            }).join('')}
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        
        <h3 style="font-size:15px; margin-bottom:12px;">Add-ons (å¢å€¼åŒ…)</h3>
        <div class="addon-grid">${pAddons.map(a => `
            <div class="addon-card">
                <div class="addon-info">
                    <div style="font-weight:600; font-size:15px;">${a.name}</div>
                    <div style="font-size:12px; color:#64748b; margin-top:4px;">${a.ents.length} é¡¹èƒ½åŠ›</div>
                </div>
                <div class="addon-actions">
                    <button class="btn btn-outline" style="font-size:12px; padding:4px 8px;" onclick="openDrawer('${a.id}')">é…ç½®å†…å®¹</button>
                    <div style="display:flex;">
                        <button class="btn btn-icon" onclick="openSkuModal('${a.id}')">âœï¸</button>
                        <button class="btn btn-icon" style="color:red" onclick="deleteItem('sku','${a.id}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>`).join('')}
        </div>`;
        c.innerHTML = html;
    }

    // 6. Entitlements
    function renderEnts(c, h, ha) {
        h.innerText = 'å®¢æˆ·æƒç›Šç®¡ç† (Tenants)';
        ha.innerHTML = `<button class="btn btn-primary" onclick="openNewTenantModal()">+ ç­¾çº¦æ–°å®¢æˆ·</button>`;
        c.innerHTML = `<div style="display:flex; flex-direction:column; gap:16px;">${tenants.map((t, ti) => `
            <div class="card" style="margin:0;">
                <div class="card-header">${t.name}</div>
                <table>
                    ${t.subs.map((s, si) => {
                        const sku = skus.find(k=>k.id===s.skuId);
                        const stColor = s.status === 'Active' ? 'tag-green' : 'tag-red';
                        return `<tr>
                            <td style="padding-left:24px; font-weight:500;">${sku?sku.name:s.skuId}</td>
                            <td>${s.seats} Seats</td>
                            <td>${s.end || '-'}</td>
                            <td><span class="tag ${stColor}">${s.status}</span></td>
                            <td style="text-align:right;"><button class="btn btn-outline" style="padding:4px 10px;" onclick="openSubModal('${t.id}',${si})">å˜æ›´</button></td>
                        </tr>`;
                    }).join('')}
                </table>
            </div>`).join('')}</div>`;
    }

    // ================== LOGIC ==================

    // --- CRUD: Feature ---
    function saveFeature() {
        const id = document.getElementById('feat-id').value;
        const name = document.getElementById('feat-name').value;
        const owner = document.getElementById('feat-owner').value;
        if(id && name) {
            features.push({ id, name, owner });
            closeModals(); render();
        }
    }

    // --- CRUD: Capability ---
    function saveCap() {
        const name = document.getElementById('cap-name').value;
        const scope = document.getElementById('cap-scope').value;
        const fid = document.getElementById('cap-feat').value;
        const prod = document.getElementById('cap-prod').value;
        if(name) {
            capabilities.push({ id: 'c'+Date.now(), name, scope, fid, prod });
            closeModals(); render();
        }
    }

    // --- CRUD: Rule ---
    function saveRule() {
        const type = document.getElementById('rule-type').value;
        const desc = document.getElementById('rule-desc').value;
        const src = document.getElementById('rule-src').value;
        const tgt = document.getElementById('rule-tgt').value;
        rules.push({ id: 'r'+Date.now(), type, desc, src, tgt });
        closeModals(); render();
    }

    // --- CRUD: Product ---
    function saveProduct() {
        const name = document.getElementById('prod-name').value;
        const code = document.getElementById('prod-code').value;
        if(editItem) {
            editItem.name = name; editItem.code = code;
        } else {
            products.push({ id: 'p'+Date.now(), name, code });
        }
        closeModals(); render();
    }

    // --- CRUD: SKU ---
    function saveSku() {
        const name = document.getElementById('sku-name').value;
        const type = document.getElementById('sku-type').value;
        if(editItem) {
            editItem.name = name;
        } else {
            skus.push({ id: 's'+Date.now(), pid: activeProdId, type, name, ents: [] });
        }
        closeModals(); render();
    }

    // --- CRUD: Tenants ---
    function saveSub() {
        const { tid, idx } = editSubRef;
        const sub = tenants.find(t=>t.id===tid).subs[idx];
        sub.seats = document.getElementById('sub-seats').value;
        sub.end = document.getElementById('sub-date').value;
        sub.status = document.getElementById('sub-status').value;
        closeModals(); render();
    }

    function saveNewTenant() {
        const name = document.getElementById('new-t-name').value;
        const skuId = document.getElementById('new-t-sku').value;
        const seats = document.getElementById('new-t-seats').value;
        if(name && skuId) {
            tenants.push({ id: 't'+Date.now(), name, subs: [{ skuId, seats, status: 'Active' }] });
            closeModals(); render();
        }
    }

    // --- Actions ---
    function deleteItem(type, id) {
        if(!confirm('ç¡®å®šåˆ é™¤å—?')) return;
        if(type==='feature') features = features.filter(x=>x.id!==id);
        if(type==='cap') capabilities = capabilities.filter(x=>x.id!==id);
        if(type==='rule') rules = rules.filter(x=>x.id!==id);
        if(type==='prod') { products = products.filter(x=>x.id!==id); skus = skus.filter(x=>x.pid!==id); }
        if(type==='sku') skus = skus.filter(x=>x.id!==id);
        render();
    }

    function toggleEnt(skuId, capId) {
        const sku = skus.find(s=>s.id===skuId);
        if(sku.ents.includes(capId)) sku.ents = sku.ents.filter(x=>x!==capId);
        else sku.ents.push(capId);
        render();
    }

    // --- Drawer Logic ---
    function openDrawer(sid) {
        drawerAddonId = sid;
        const addon = skus.find(s=>s.id===sid);
        document.getElementById('drawer-title').innerText = `é…ç½® ${addon.name}`;
        document.getElementById('drawer-mask').style.display = 'block';
        setTimeout(()=>document.getElementById('drawer').classList.add('open'),10);
        renderDrawerList();
    }
    function closeDrawer() {
        document.getElementById('drawer').classList.remove('open');
        setTimeout(()=>document.getElementById('drawer-mask').style.display = 'none',300);
        render();
    }
    function toggleDrawerFilter() {
        drawerFilter = !drawerFilter;
        document.getElementById('drawer-check').checked = drawerFilter;
        renderDrawerList(document.querySelector('#drawer input').value);
    }
    function renderDrawerList(filterText = '') {
        const addon = skus.find(s=>s.id===drawerAddonId);
        const prodCaps = capabilities.filter(c=>c.prod === activeProdId);
        const list = document.getElementById('drawer-list');
        list.innerHTML = prodCaps.map(c => {
            const has = addon.ents.includes(c.id);
            if(drawerFilter && !has) return '';
            if(filterText && !c.name.includes(filterText)) return '';
            return `<div style="padding:12px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <div><div style="font-weight:500">${c.name}</div><div style="font-size:11px; color:#94a3b8">${c.scope}</div></div>
                <div onclick="toggleDrawerEnt('${c.id}')" style="cursor:pointer;"><div class="check-box ${has?'checked':''}"></div></div>
            </div>`;
        }).join('');
    }
    function toggleDrawerEnt(cid) {
        const addon = skus.find(s=>s.id===drawerAddonId);
        if(addon.ents.includes(cid)) addon.ents = addon.ents.filter(x=>x!==cid);
        else addon.ents.push(cid);
        renderDrawerList(document.querySelector('#drawer input').value);
    }

    // --- Modal Helpers ---
    function openModal(type) {
        document.querySelectorAll('.mask').forEach(el=>el.style.display='none');
        editItem = null;
        
        if(type==='cap') {
            document.getElementById('cap-feat').innerHTML = features.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
            document.getElementById('cap-prod').innerHTML = products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        }
        if(type==='rule') {
            const opts = capabilities.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('rule-src').innerHTML = opts; document.getElementById('rule-tgt').innerHTML = opts;
        }
        if(type==='feature') { document.getElementById('feat-id').value=''; document.getElementById('feat-name').value=''; }
        if(type==='prod') { document.getElementById('prod-modal-title').innerText='æ–°å»ºäº§å“çº¿'; document.getElementById('prod-name').value=''; document.getElementById('prod-code').value=''; }
        if(type==='sku') { 
            const p = products.find(x=>x.id===activeProdId);
            document.getElementById('sku-modal-title').innerText='æ–°å»º SKU';
            document.getElementById('sku-prod-disp').value = p.name;
            document.getElementById('sku-type').disabled = false;
        }
        document.getElementById(`modal-${type}`).style.display = 'flex';
    }

    function openProdModal(pid=null) {
        openModal('prod');
        if(pid) {
            editItem = products.find(x=>x.id===pid);
            document.getElementById('prod-modal-title').innerText='ç¼–è¾‘äº§å“çº¿';
            document.getElementById('prod-name').value = editItem.name;
            document.getElementById('prod-code').value = editItem.code;
        }
    }

    function openSkuModal(sid=null) {
        openModal('sku');
        if(sid) {
            editItem = skus.find(x=>x.id===sid);
            document.getElementById('sku-modal-title').innerText='ç¼–è¾‘ SKU';
            document.getElementById('sku-name').value = editItem.name;
            document.getElementById('sku-type').value = editItem.type;
            document.getElementById('sku-type').disabled = true;
        }
    }

    function openSubModal(tid, idx) {
        editSubRef = { tid, idx };
        const sub = tenants.find(t=>t.id===tid).subs[idx];
        const sku = skus.find(s=>s.id===sub.skuId);
        document.getElementById('sub-tenant').innerText = tenants.find(t=>t.id===tid).name;
        document.getElementById('sub-sku').innerText = sku ? sku.name : sub.skuId;
        document.getElementById('sub-seats').value = sub.seats;
        document.getElementById('sub-date').value = sub.end || '';
        document.getElementById('sub-status').value = sub.status;
        document.getElementById('modal-sub').style.display = 'flex';
    }

    function openNewTenantModal() {
        const opts = skus.filter(s=>s.type==='PLAN').map(s=>`<option value="${s.id}">${products.find(p=>p.id===s.pid).code} - ${s.name}</option>`).join('');
        document.getElementById('new-t-sku').innerHTML = opts;
        document.getElementById('modal-new-t').style.display = 'flex';
    }

    function closeModals() { document.querySelectorAll('.mask').forEach(el=>el.style.display='none'); }

    // Start
    route('products');
</script>
</body>
</html>